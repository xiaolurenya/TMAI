<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M-Team 自动投注系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js"></script>
    <script>
        // 配置Tailwind
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        success: '#52C41A',
                        warning: '#FAAD14',
                        danger: '#FF4D4F',
                        dark: '#1F2937',
                        light: '#F9FAFB',
                        purple: '#7B61FF'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            }
            .hover-lift {
                transition: transform 0.2s, box-shadow 0.2s;
            }
            .hover-lift:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
            }
            .table-hover-row:hover {
                background-color: rgba(22, 93, 255, 0.03);
            }
            .odds-highlight {
                background-color: rgba(82, 196, 26, 0.1);
                font-weight: bold;
            }
            .follower-indicator {
                position: relative;
                padding-left: 1.5rem;
            }
            .follower-indicator::before {
                content: "→";
                position: absolute;
                left: 0;
                color: #7B61FF;
                font-weight: bold;
            }
            .scrollbar-thin {
                scrollbar-width: thin;
            }
            .scrollbar-thin::-webkit-scrollbar {
                width: 4px;
                height: 4px;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb {
                background-color: rgba(156, 163, 175, 0.5);
                border-radius: 2px;
            }
            /* 投注结果弹窗样式 */
            .bet-modal-backdrop {
                backdrop-filter: blur(2px);
                background-color: rgba(0, 0, 0, 0.5);
            }
            .bet-modal-content {
                animation: fadeIn 0.3s ease-in-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            /* 日志颜色标记 */
            .log-success { color: #52C41A; font-weight: 500; }
            .log-error { color: #FF4D4F; font-weight: 500; }
            .log-warning { color: #FAAD14; font-weight: 500; }
            .log-info { color: #165DFF; font-weight: 500; }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- 顶部导航栏 -->
        <header class="mb-6">
            <div class="bg-white rounded-xl card-shadow p-4 mb-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <h1 class="text-2xl font-bold text-dark flex items-center">
                        <i class="fa fa-line-chart text-primary mr-2"></i>
                        M-Team 自动投注系统
                    </h1>
                    
                    <div class="flex items-center space-x-4 w-full md:w-auto">
                        <div class="flex items-center bg-gray-100 px-3 py-1.5 rounded-lg">
                            <span id="serviceStatusIndicator" class="inline-block w-3 h-3 rounded-full bg-gray-400 mr-2"></span>
                            <span id="serviceStatusText" class="text-sm font-medium">服务未运行</span>
                        </div>
                        
                        <div class="flex gap-2 flex-1 md:flex-none">
                            <button id="startServiceBtn" onclick="startService()" class="flex-1 bg-success hover:bg-success/90 text-white px-4 py-2 rounded-lg transition hover-lift flex items-center justify-center">
                                <i class="fa fa-play mr-2"></i> 启动服务
                            </button>
                            <button id="stopServiceBtn" onclick="stopService()" class="flex-1 bg-danger hover:bg-danger/90 text-white px-4 py-2 rounded-lg transition hover-lift opacity-50 cursor-not-allowed" disabled>
                                <i class="fa fa-stop mr-2"></i> 停止服务
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-wrap gap-3 pt-2 text-sm">
                    <div class="flex items-center bg-gray-50 px-3 py-1.5 rounded-lg">
                        <span class="text-gray-600 mr-2">刷新间隔:</span>
                        <span id="refreshIntervalDisplay" class="font-mono text-primary">00:00:30.000</span>
                    </div>
                    
                    <button id="autoRefreshBtn" onclick="toggleAutoRefresh()" class="text-primary hover:text-primary/80 flex items-center px-3 py-1.5 rounded-lg hover:bg-primary/5 transition">
                        <i class="fa fa-refresh mr-1"></i> 关闭自动刷新
                    </button>
                    
                    <button onclick="manualRefresh()" class="text-primary hover:text-primary/80 flex items-center px-3 py-1.5 rounded-lg hover:bg-primary/5 transition">
                        <i class="fa fa-sync mr-1"></i> 手动刷新
                    </button>
                    
                    <button onclick="toggleLogModal()" class="text-primary hover:text-primary/80 flex items-center px-3 py-1.5 rounded-lg hover:bg-primary/5 transition ml-auto">
                        <i class="fa fa-list-alt mr-1"></i> 查看日志
                    </button>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- 主内容区 -->
            <div class="lg:col-span-2 space-y-6">
                <!-- 可投注项目 -->
                <div class="bg-white rounded-xl card-shadow overflow-hidden transition-all duration-300 hover-lift">
                    <div class="bg-gray-50 px-5 py-4 border-b border-gray-100">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fa fa-list-ol text-primary mr-2"></i> 可投注项目
                            <span id="availableBetsCount" class="ml-2 text-sm font-normal text-gray-500">0 个项目</span>
                        </h2>
                    </div>
                    <div class="p-4">
                        <div class="overflow-x-auto scrollbar-thin">
                            <table id="betItemsTable" class="min-w-full divide-y divide-gray-200">
                                <tr>
                                    <td colspan="7" class="border border-gray-200 p-8 text-center text-gray-500">
                                        <div class="flex flex-col items-center">
                                            <i class="fa fa-inbox text-3xl mb-2 text-gray-300"></i>
                                            <span>请启动服务加载数据</span>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 待投注项目 -->
                <div class="bg-white rounded-xl card-shadow overflow-hidden transition-all duration-300 hover-lift">
                    <div class="bg-gray-50 px-5 py-4 border-b border-gray-100">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fa fa-clock-o text-primary mr-2"></i> 待投注项目
                            <span id="pendingBetsCount" class="ml-2 text-sm font-normal text-gray-500">0 个项目</span>
                        </h2>
                    </div>
                    <div class="p-4">
                        <div class="overflow-x-auto scrollbar-thin">
                            <table id="pendingBetsTable" class="min-w-full divide-y divide-gray-200">
                                <tr>
                                    <td colspan="7" class="border border-gray-200 p-8 text-center text-gray-500">
                                        <div class="flex flex-col items-center">
                                            <i class="fa fa-hourglass-o text-3xl mb-2 text-gray-300"></i>
                                            <span>暂无待投注项目</span>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 操作日志 -->
                <div class="bg-white rounded-xl card-shadow overflow-hidden transition-all duration-300 hover-lift">
                    <div class="bg-gray-50 px-5 py-4 border-b border-gray-100">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fa fa-history text-primary mr-2"></i> 操作日志
                        </h2>
                    </div>
                    <div id="logPanel" class="h-48 overflow-y-auto p-4 border-t border-gray-100 text-sm scrollbar-thin"></div>
                </div>
            </div>

            <!-- 配置面板 -->
            <div class="lg:col-span-1 space-y-6">
                <!-- 基本配置 -->
                <div class="bg-white rounded-xl card-shadow overflow-hidden transition-all duration-300 hover-lift">
                    <div class="bg-gray-50 px-5 py-4 border-b border-gray-100">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fa fa-cog text-primary mr-2"></i> 基本配置
                        </h2>
                    </div>
                    <div class="p-5 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                            <input type="text" id="apiKeyInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition" placeholder="输入API Key">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">目标用户ID (跟随模式)</label>
                            <input type="text" id="targetUserIdInput" value="205809" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">投注策略</label>
                            <select id="betStrategySelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition">
                                <option value="higher_odds">最高赔率优先</option>
                                <option value="follow">跟随目标用户</option>
                                <option value="larger">押大</option>
                                <option value="smaller">押小</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">提前下注时间 (秒)</label>
                            <input type="number" id="advanceSecondsInput" value="3" min="0" max="60" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition">
                        </div>
                    </div>
                </div>

                <!-- 金额设置 -->
                <div class="bg-white rounded-xl card-shadow overflow-hidden transition-all duration-300 hover-lift">
                    <div class="bg-gray-50 px-5 py-4 border-b border-gray-100">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fa fa-money text-primary mr-2"></i> 金额设置
                        </h2>
                    </div>
                    <div class="p-5 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">基础投注金额</label>
                            <input type="number" id="baseAmountInput" value="10000" min="100" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition">
                        </div>
                    </div>
                </div>

                <!-- 刷新设置 -->
                <div class="bg-white rounded-xl card-shadow overflow-hidden transition-all duration-300 hover-lift">
                    <div class="bg-gray-50 px-5 py-4 border-b border-gray-100">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fa fa-refresh text-primary mr-2"></i> 刷新设置
                        </h2>
                    </div>
                    <div class="p-5 space-y-4">
                        <div class="grid grid-cols-3 gap-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">时</label>
                                <input type="number" id="refreshHoursInput" value="0" min="0" max="23" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">分</label>
                                <input type="number" id="refreshMinutesInput" value="0" min="0" max="59" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">秒</label>
                                <input type="number" id="refreshSecondsInput" value="30" min="5" max="60" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">检查间隔 (秒)</label>
                            <input type="number" id="checkIntervalInput" value="2" min="0.1" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">跟随检查间隔 (毫秒)</label>
                            <input type="number" id="followCheckIntervalInput" value="500" min="100" max="3000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition">
                        </div>
                    </div>
                </div>

                <!-- 定时任务 -->
                <div class="bg-white rounded-xl card-shadow overflow-hidden transition-all duration-300 hover-lift">
                    <div class="bg-gray-50 px-5 py-4 border-b border-gray-100">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fa fa-calendar-check-o text-primary mr-2"></i> 定时任务
                        </h2>
                    </div>
                    <div class="p-5 space-y-4">
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="schedule1EnabledCheckbox" class="form-checkbox h-5 w-5 text-primary rounded focus:ring-primary/50">
                                <span class="ml-2 text-sm text-gray-700">启用第一组定时任务</span>
                            </label>
                            <div class="mt-2 grid grid-cols-2 gap-2 pl-7">
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">开始时间</label>
                                    <input type="time" id="schedule1StartTimeInput" value="09:00" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">结束时间</label>
                                    <input type="time" id="schedule1StopTimeInput" value="23:00" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition text-sm">
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="schedule2EnabledCheckbox" class="form-checkbox h-5 w-5 text-primary rounded focus:ring-primary/50">
                                <span class="ml-2 text-sm text-gray-700">启用第二组定时任务</span>
                            </label>
                            <div class="mt-2 grid grid-cols-2 gap-2 pl-7">
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">开始时间</label>
                                    <input type="time" id="schedule2StartTimeInput" value="00:00" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">结束时间</label>
                                    <input type="time" id="schedule2StopTimeInput" value="06:00" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 其他设置 -->
                <div class="bg-white rounded-xl card-shadow overflow-hidden transition-all duration-300 hover-lift">
                    <div class="bg-gray-50 px-5 py-4 border-b border-gray-100">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fa fa-filter text-primary mr-2"></i> 其他设置
                        </h2>
                    </div>
                    <div class="p-5 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">待投注筛选</label>
                            <select id="pendingFilterSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition">
                                <option value="all">全部</option>
                                <option value="highest_odds">最高赔率</option>
                                <option value="highest_amount">最高金额</option>
                                <option value="ratio_based">最佳比例</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="detailedLogModeCheckbox" class="form-checkbox h-5 w-5 text-primary rounded focus:ring-primary/50">
                                <span class="ml-2 text-sm text-gray-700">详细日志模式</span>
                            </label>
                        </div>
                        
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="aiPredictionEnabledCheckbox" checked class="form-checkbox h-5 w-5 text-primary rounded focus:ring-primary/50">
                                <span class="ml-2 text-sm text-gray-700">启用AI预测</span>
                            </label>
                        </div>
                        
                        <button onclick="saveParameters()" class="w-full bg-primary hover:bg-primary/90 text-white py-2.5 rounded-lg transition hover-lift">
                            保存配置
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 日志弹窗 -->
    <div id="logModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl w-full max-w-4xl max-h-[90vh] flex flex-col shadow-xl">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="font-semibold text-lg">详细日志</h3>
                <div class="flex space-x-2">
                    <button onclick="Logger.clear()" class="text-sm text-gray-600 hover:text-gray-900 px-3 py-1 rounded hover:bg-gray-100 transition">
                        <i class="fa fa-trash mr-1"></i> 清空
                    </button>
                    <button onclick="toggleLogModal()" class="text-gray-600 hover:text-gray-900 p-1 rounded-full hover:bg-gray-100 transition">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            <div id="logModalPanel" class="flex-1 overflow-y-auto p-4 text-sm scrollbar-thin"></div>
        </div>
    </div>

    <!-- 投注结果弹窗 -->
    <div id="betResultModal" class="fixed inset-0 bet-modal-backdrop hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl w-full max-w-md bet-modal-content shadow-xl">
            <div class="p-6 border-b">
                <h3 class="font-semibold text-xl flex items-center" id="betResultTitle">
                    <i class="fa fa-info-circle mr-2" id="betResultIcon"></i>
                    投注结果
                </h3>
            </div>
            <div class="p-6">
                <div class="mb-6" id="betResultContent">
                    <!-- 结果内容将动态插入 -->
                </div>
                <button onclick="closeBetResultModal()" class="w-full bg-primary hover:bg-primary/90 text-white py-2.5 rounded-lg transition hover-lift">
                    确认
                </button>
            </div>
        </div>
    </div>

    <script>
        // 安全机制 - 防调试和防复制
        (function() {
            const antiDebug = () => {
                if (window.outerHeight - window.innerHeight > 200 || window.outerWidth - window.innerWidth > 200) {
                    document.body.innerHTML = '<div class="flex items-center justify-center h-screen bg-danger text-white text-xl">检测到非法调试行为，系统已保护</div>';
                    return;
                }
                requestAnimationFrame(antiDebug);
            };
            antiDebug();

            document.addEventListener('contextmenu', e => e.preventDefault());
            document.addEventListener('selectstart', e => e.preventDefault());
            document.addEventListener('keydown', e => {
                if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                    e.preventDefault();
                    alert('禁止调试');
                }
            });
        })();

        if (typeof axios === 'undefined') {
            document.write('<script src="https://unpkg.com/axios@1.6.2/dist/axios.min.js"><\/script>');
        }

        // 字符串哈希函数，用于临时生成teamId
        String.prototype.hashCode = function() {
            let hash = 0;
            for (let i = 0; i < this.length; i++) {
                const char = this.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // 转换为32位整数
            }
            return Math.abs(hash);
        };

        // 全局变量
        let autoRefreshTimer = null;
        let betCheckTimer = null;
        let followCheckTimers = {}; // 跟随模式专用检查定时器
        let pendingBets = [];
        let isServiceRunning = false;
        let logModalVisible = false;
        let lastActivityTime = 0;
        let isPageVisible = true;
        let countdownTimer = null;
        let refreshCycleStartTime = 0; // 记录当前刷新周期的开始时间戳
        let scheduleTimers = { check1: null, check2: null }; // 定时启动/停止定时器
        let isBetModalOpen = false; // 投注结果弹窗状态
        
        // AI分析相关数据存储
        const AIAnalytics = {
            historicalData: {}, // 存储历史数据 {teamId: {wins, losses, total, recentScores: []}}
            predictionCache: {} // 缓存预测结果 {gameId: {prediction, confidence}}
        };
        
        const GlobalInfo = {
            bet_mask: {},
            available_bets: [],
            my_bet_log: [],
            configs: {},
            followedBets: {} // 记录已跟随的投注 {gameId: {optionId, amount}}
        };

        // 日志系统（新增颜色标记）
        const Logger = {
            logs: [],
            detailedMode: false,
            log(content, level = "INFO", detailed = false) {
                if (detailed && !this.detailedMode) return;
                
                const now = new Date().toLocaleString("zh-CN", {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    fractionalSecondDigits: 3
                });
                
                // 日志级别颜色标记
                let levelClass = '';
                switch(level) {
                    case 'SUCCESS': levelClass = 'log-success'; break;
                    case 'ERROR': levelClass = 'log-error'; break;
                    case 'WARN': levelClass = 'log-warning'; break;
                    case 'INFO': levelClass = 'log-info'; break;
                }
                
                const logItem = `[${now}] <span class="${levelClass}">[${level}]</span> ${content}`;
                this.logs.unshift(logItem);
                if (this.logs.length > 500) this.logs.pop();
                this.render();
            },
            info(content, detailed = false) { this.log(content, "INFO", detailed); },
            error(content, detailed = false) { this.log(content, "ERROR", detailed); },
            warning(content, detailed = false) { this.log(content, "WARN", detailed); },
            success(content, detailed = false) { this.log(content, "SUCCESS", detailed); }, // 新增成功日志级别
            clear() {
                this.logs = [];
                this.render();
                this.info("日志已清空");
            },
            render() {
                const mainPanel = document.getElementById('logPanel');
                if (mainPanel) {
                    mainPanel.innerHTML = this.logs.map(log => 
                        `<div class="py-1">${log}</div>`
                    ).join("");
                    mainPanel.scrollTop = mainPanel.scrollHeight;
                }
                
                const modalPanel = document.getElementById('logModalPanel');
                if (modalPanel) {
                    modalPanel.innerHTML = this.logs.map(log => 
                        `<div class="py-1">${log}</div>`
                    ).join("");
                    modalPanel.scrollTop = modalPanel.scrollHeight;
                }
            },
            toggleDetailedMode(enabled) {
                this.detailedMode = enabled;
                this.info(`详细日志模式已${enabled ? '开启' : '关闭'}`, true);
            }
        };

        // 配置
        const CONFIG = {
            mainHost: "https://api.m-team.io/api",
            testHost: "https://test2.m-team.cc/api",
            apis: {
                "get_current_bet": "bet/findBetgameList?active=LIVE&fix=0",
                "betgameOdds": "bet/betgameOdds?optId={optId}&bonus={bonus}",
                "get_details": "bet/getDetail?gameId={gameId}",
                "get_gamblers": "bet/getDetailBetList?gameId={gameId}",
                "get_my_bet_log": "bet/myCouponLog",
                "get_team_history": "team/getHistory?teamId={teamId}"
            },
            state: {
                availableBets: [],
                autoRefresh: true,
                refreshInterval: 30,
                targetUserId: "205809",
                advanceSeconds: 3,
                baseAmount: 10000,
                betStrategy: "higher_odds",
                checkInterval: 2,
                detailedLogMode: false,
                pendingFilter: "all",
                aiPredictionEnabled: true,
                followCheckInterval: 500,
                // 定时任务配置
                schedule1Enabled: false,
                schedule1StartTime: "09:00",
                schedule1StopTime: "23:00",
                schedule2Enabled: false,
                schedule2StartTime: "00:00",
                schedule2StopTime: "06:00"
            }
        };

        // 核心请求函数
        async function request(url, method = 'post', data = {}, retry = 1) {
            try {
                const response = await axios({
                    method,
                    url,
                    data,
                    headers: {
                        "x-api-key": document.getElementById("apiKeyInput").value || "",
                        "Content-Type": "application/json"
                    },
                    timeout: 15000
                });
                Logger.info(`请求成功: ${url}`, true);
                return response.data;
            } catch (e) {
                Logger.error(`请求失败: ${e.message} (${url})`, true);
                if (retry > 0) {
                    Logger.warning(`尝试重试请求: ${url}`, true);
                    return request(url, method, data, retry - 1);
                }
                throw new Error(`请求失败: ${e.message}`);
            }
        }

        // API验证逻辑
        async function verifyApiKey() {
            const apiKey = document.getElementById("apiKeyInput").value;
            if (!apiKey) {
                Logger.warning("请输入API Key");
                return false;
            }

            try {
                Logger.info("正在验证API Key（通过获取投注列表）...");
                const result = await request(`${CONFIG.mainHost}/${CONFIG.apis.get_current_bet}`);
                if (result && (result.data || result.code === 0)) {
                    Logger.success("API Key验证成功");
                    return true;
                } else {
                    Logger.error(`API Key验证失败: 响应格式不正确`);
                    return false;
                }
            } catch (e) {
                Logger.warning("主服务器验证失败，尝试备用服务器...");
                try {
                    const result = await request(`${CONFIG.testHost}/${CONFIG.apis.get_current_bet}`);
                    if (result && (result.data || result.code === 0)) {
                        Logger.success("备用服务器API Key验证成功");
                        return true;
                    } else {
                        Logger.error(`备用服务器API Key验证失败: 响应格式不正确`);
                        return false;
                    }
                } catch (e2) {
                    Logger.error(`API Key验证失败: ${e2.message}`);
                    return false;
                }
            }
        }

        // 获取可投注项目
        async function loadBetItems() {
            updateLastActivity();
            try {
                Logger.info("正在获取可投注项目...", true);
                const data = await request(`${CONFIG.mainHost}/${CONFIG.apis.get_current_bet}`);
                CONFIG.state.availableBets = Array.isArray(data?.data) ? data.data : [];
                GlobalInfo.available_bets = CONFIG.state.availableBets;
                
                Logger.info(`找到可下注项目（${CONFIG.state.availableBets.length} 个）`);
                document.getElementById("availableBetsCount").textContent = `${CONFIG.state.availableBets.length} 个项目`;
                
                CONFIG.state.availableBets.forEach((betitem, idx) => {
                    Logger.info(`[ ${idx + 1} / ${CONFIG.state.availableBets.length} ] 项目id: ${betitem.id} 结束时间： ${betitem.endtime}`);
                    Logger.info(`${betitem.heading}, ${betitem.undertext || ''}`);
                    
                    if (betitem.optionsList && betitem.optionsList.length > 0) {
                        Logger.info(`可下注选项(共${betitem.optionsList.length}个)：`, true);
                        betitem.optionsList.forEach((opt, optIdx) => {
                            Logger.info(`  [${optIdx + 1}] ${opt.text} (赔率: ${opt.odds})`, true);
                        });
                    }
                    
                    // AI分析
                    if (CONFIG.state.betStrategy !== "follow" && CONFIG.state.aiPredictionEnabled) {
                        analyzeWithAI(betitem);
                    }
                    
                    // 跟随模式监控
                    if (CONFIG.state.betStrategy === "follow" && isServiceRunning) {
                        startFollowingCheck(betitem.id);
                    }
                });
                
                await flushConfig();
                processPendingBets(true);
                renderBetTable();
                resetRefreshCycle();
                return true;
            } catch (e) {
                Logger.warning("主服务器获取失败，尝试备用服务器...");
                try {
                    const data = await request(`${CONFIG.testHost}/${CONFIG.apis.get_current_bet}`);
                    CONFIG.state.availableBets = Array.isArray(data?.data) ? data.data : [];
                    GlobalInfo.available_bets = CONFIG.state.availableBets;
                    
                    Logger.info(`从备用服务器找到可下注项目（${CONFIG.state.availableBets.length} 个）`);
                    document.getElementById("availableBetsCount").textContent = `${CONFIG.state.availableBets.length} 个项目`;
                    
                    await flushConfig();
                    processPendingBets(true);
                    renderBetTable();
                    resetRefreshCycle();
                    return true;
                } catch (e2) {
                    Logger.error(`获取投注项目失败: ${e2.message}`);
                    resetRefreshCycle();
                    return false;
                }
            }
        }

        // 刷新配置
        async function flushConfig() {
            const availableBets = GlobalInfo.available_bets;
            const newConfigs = {};
            
            GlobalInfo.bet_mask = {};
            
            availableBets.forEach(bet => {
                const id = bet.id;
                GlobalInfo.bet_mask[id] = [];
                
                const endTime = new Date(bet.endtime);
                const scheduledTime = new Date(endTime.getTime() - CONFIG.state.advanceSeconds * 1000);
                const scheduledTimeMulti = new Date(endTime.getTime() - CONFIG.state.advanceSeconds * 1000);
                
                newConfigs[id] = {
                    bet_id: id,
                    desc: `${bet.heading}, ${bet.undertext || ''}`,
                    scheduled_time: scheduledTime,
                    scheduled_time_multi: scheduledTimeMulti,
                    endtime: bet.endtime,
                    bias: CONFIG.state.advanceSeconds,
                    bonus: CONFIG.state.baseAmount,
                    option_type: CONFIG.state.betStrategy
                };
            });
            
            GlobalInfo.configs = newConfigs;
            Logger.info(`配置已刷新，应用统一提前下注(${CONFIG.state.advanceSeconds}s)`, true);
        }

        // 处理待投注项目
        function processPendingBets(refresh = false) {
            const now = new Date();
            const processingItems = refresh ? pendingBets.filter(bet => bet.status === "处理中") : [];
            let newPendingBets = [...processingItems];
            
            const candidateBets = [];
            Object.values(GlobalInfo.configs).forEach(cfg => {
                if (processingItems.some(bet => bet.id === cfg.bet_id)) {
                    return;
                }
                
                try {
                    const betItem = CONFIG.state.availableBets.find(item => item.id === cfg.bet_id);
                    if (!betItem) return;
                    
                    // 跟随模式不加入定时投注队列
                    if (CONFIG.state.betStrategy === "follow") {
                        return;
                    }
                    
                    const betTime = cfg.scheduled_time;
                    
                    if (betTime > now) {
                        if (shouldPlaceBet(betItem)) {
                            // 获取AI预测结果
                            const aiPrediction = AIAnalytics.predictionCache[betItem.id];
                            const selectedOption = aiPrediction 
                                ? betItem.optionsList.find(opt => opt.text.includes(aiPrediction.prediction))
                                : getHighestOddsOption(betItem);
                            
                            const betAmount = calculateBetAmount();
                            const odds = selectedOption ? parseFloat(selectedOption.odds) : 0;
                            const ratioValue = odds * betAmount;
                            
                            candidateBets.push({
                                ...betItem,
                                id: cfg.bet_id,
                                betTime,
                                betAmount,
                                strategy: CONFIG.state.betStrategy,
                                status: "等待中",
                                highestOdds: odds,
                                highestOddsTeam: selectedOption ? selectedOption.text : 'N/A',
                                ratioValue: ratioValue,
                                recordedOdds: odds,
                                aiPrediction: aiPrediction ? `【AI】${aiPrediction.prediction} (${(aiPrediction.confidence * 100).toFixed(1)}%)` : null
                            });
                        }
                    }
                } catch (e) {
                    Logger.error(`处理项目 #${cfg.bet_id} 失败: ${e.message}`, true);
                }
            });
            
            let selectedBets = [];
            const betsByTimeGroup = {};
            candidateBets.forEach(bet => {
                const timeGroup = new Date(bet.betTime).toLocaleString('zh-CN', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                if (!betsByTimeGroup[timeGroup]) {
                    betsByTimeGroup[timeGroup] = [];
                }
                betsByTimeGroup[timeGroup].push(bet);
            });
            
            switch (CONFIG.state.pendingFilter) {
                case "all":
                    Object.values(betsByTimeGroup).forEach(group => {
                        selectedBets.push(...group);
                        Logger.info(`时间组 ${new Date(group[0].betTime).toLocaleString()} 选择所有 ${group.length} 个项目`, true);
                    });
                    break;
                    
                case "highest_odds":
                    Object.values(betsByTimeGroup).forEach(group => {
                        if (group.length === 0) return;
                        const selected = group.reduce((max, bet) => bet.highestOdds > max.highestOdds ? bet : max, group[0]);
                        selectedBets.push(selected);
                        Logger.info(`时间组 ${new Date(group[0].betTime).toLocaleString()} 选择最高赔率项目 #${selected.id} (${selected.highestOdds})`, true);
                    });
                    break;
                    
                case "highest_amount":
                    Object.values(betsByTimeGroup).forEach(group => {
                        if (group.length === 0) return;
                        const selected = group.reduce((max, bet) => bet.betAmount > max.betAmount ? bet : max, group[0]);
                        selectedBets.push(selected);
                        Logger.info(`时间组 ${new Date(group[0].betTime).toLocaleString()} 选择最高金额项目 #${selected.id} (${selected.betAmount})`, true);
                    });
                    break;
                    
                case "ratio_based":
                    Object.values(betsByTimeGroup).forEach(group => {
                        if (group.length === 0) return;
                        const selected = group.reduce((max, bet) => bet.ratioValue > max.ratioValue ? bet : max, group[0]);
                        selectedBets.push(selected);
                        Logger.info(`时间组 ${new Date(group[0].betTime).toLocaleString()} 选择最佳比例项目 #${selected.id} (${selected.ratioValue.toFixed(2)})`, true);
                    });
                    break;
            }
            
            newPendingBets = [...newPendingBets, ...selectedBets];
            newPendingBets.sort((a, b) => a.betTime - b.betTime);
            pendingBets = newPendingBets;
            document.getElementById("pendingBetsCount").textContent = `${pendingBets.length} 个项目`;
            renderPendingBetsTable();
        }

        // 获取目标用户的投注记录
        async function getTargetUserBet(gameId) {
            try {
                Logger.info(`尝试获取目标用户 ${CONFIG.state.targetUserId} 的投注记录 (项目 #${gameId})`, true);
                const url = `${CONFIG.mainHost}/${CONFIG.apis.get_gamblers.replace('{gameId}', gameId)}`;
                const data = await request(url);
                
                if (data?.data && Array.isArray(data.data)) {
                    const targetBet = data.data.find(log => log.userid === CONFIG.state.targetUserId);
                    if (targetBet) {
                        Logger.info(`找到目标用户 ${CONFIG.state.targetUserId} 的投注记录: 选项 ${targetBet.optionid}, 金额 ${targetBet.bonus}`, true);
                    } else {
                        Logger.info(`未找到目标用户 ${CONFIG.state.targetUserId} 的投注记录`, true);
                    }
                    return targetBet;
                }
                return null;
            } catch (e) {
                Logger.warning(`获取用户投注记录失败: ${e.message}，尝试备用服务器`, true);
                try {
                    const url = `${CONFIG.testHost}/${CONFIG.apis.get_gamblers.replace('{gameId}', gameId)}`;
                    const data = await request(url);
                    
                    if (data?.data && Array.isArray(data.data)) {
                        const targetBet = data.data.find(log => log.userid === CONFIG.state.targetUserId);
                        return targetBet;
                    }
                    return null;
                } catch (e2) {
                    Logger.error(`获取用户投注记录失败: ${e2.message}`, true);
                    return null;
                }
            }
        }

        // 启动跟随检查
        function startFollowingCheck(gameId) {
            // 清除已有定时器
            if (followCheckTimers[gameId]) {
                clearInterval(followCheckTimers[gameId]);
            }
            
            // 检查是否已跟随
            if (GlobalInfo.followedBets[gameId]) {
                return;
            }
            
            // 设置新的检查定时器
            const checkInterval = CONFIG.state.followCheckInterval;
            Logger.info(`开始实时监控项目 #${gameId} 的目标用户投注 (检查间隔: ${checkInterval}ms)`, true);
            
            followCheckTimers[gameId] = setInterval(async () => {
                if (!isServiceRunning) {
                    clearInterval(followCheckTimers[gameId]);
                    delete followCheckTimers[gameId];
                    return;
                }
                
                // 检查项目是否仍然有效
                const betItem = CONFIG.state.availableBets.find(item => item.id === gameId);
                if (!betItem) {
                    clearInterval(followCheckTimers[gameId]);
                    delete followCheckTimers[gameId];
                    Logger.info(`项目 #${gameId} 已失效，停止监控`, true);
                    return;
                }
                
                // 检查是否已过投注时间
                const endTime = new Date(betItem.endtime);
                const now = new Date();
                if (now > endTime) {
                    clearInterval(followCheckTimers[gameId]);
                    delete followCheckTimers[gameId];
                    Logger.info(`项目 #${gameId} 已结束，停止监控`, true);
                    return;
                }
                
                // 检查目标用户是否已投注
                const targetBet = await getTargetUserBet(gameId);
                if (targetBet) {
                    // 找到对应的选项文本和队伍信息
                    const option = betItem.optionsList.find(opt => opt.id === targetBet.optionid);
                    if (!option) {
                        Logger.error(`跟随投注失败: 选项 ${targetBet.optionid} 不存在`);
                        clearInterval(followCheckTimers[gameId]);
                        delete followCheckTimers[gameId];
                        return;
                    }
                    
                    Logger.info(`检测到目标用户 ${CONFIG.state.targetUserId} 已投注项目 #${gameId} - ${option.text}，准备立即跟随`, true);
                    
                    // 立即执行跟随投注
                    const followBet = {
                        ...betItem,
                        id: gameId,
                        betTime: now,
                        betAmount: calculateBetAmount(),
                        strategy: "follow",
                        status: "处理中",
                        highestOddsTeam: option.text,
                        highestOdds: parseFloat(option.odds || 0),
                        ratioValue: 0,
                        recordedOdds: 0
                    };
                    
                    // 添加到待投注列表
                    pendingBets.unshift(followBet);
                    renderPendingBetsTable();
                    
                    // 执行投注
                    const success = await placeFollowBet(followBet, targetBet.optionid);
                    
                    // 显示投注结果弹窗
                    showBetResultModal({
                        success: success,
                        betId: gameId,
                        option: option.text,
                        amount: followBet.betAmount,
                        strategy: "跟随模式"
                    });
                    
                    // 更新状态
                    const index = pendingBets.findIndex(b => b.id === gameId && b.status === "处理中");
                    if (index !== -1) {
                        pendingBets[index].status = success ? "已完成" : "失败";
                        renderPendingBetsTable();
                    }
                    
                    // 记录已跟随，避免重复
                    if (success) {
                        GlobalInfo.followedBets[gameId] = {
                            optionId: targetBet.optionid,
                            amount: followBet.betAmount
                        };
                        
                        // 投注成功后自动刷新
                        Logger.success(`跟随投注成功，3秒后自动刷新可投注项目...`);
                        setTimeout(() => loadBetItems(), 3000);
                    }
                    
                    // 停止监控
                    clearInterval(followCheckTimers[gameId]);
                    delete followCheckTimers[gameId];
                }
            }, checkInterval);
        }

        // 计算投注金额
        function calculateBetAmount() {
            return Math.max(CONFIG.state.baseAmount, 100);
        }

        // 计算跟随金额
        function calculateFollowAmount(baseAmount) {
            return Math.max(CONFIG.state.baseAmount, 100);
        }

        // 执行跟随投注
        async function placeFollowBet(followBet, optionId) {
            updateLastActivity();
            try {
                Logger.info(`开始跟随投注项目 #${followBet.id}，选项: ${followBet.highestOddsTeam}, 金额: ${followBet.betAmount}`);
                
                // 检查选项是否存在
                const option = followBet.optionsList.find(opt => opt.id === optionId);
                if (!option) {
                    Logger.error(`跟随投注失败: 选项 ${optionId} 不存在`);
                    return false;
                }
                
                // 执行投注
                const url = `${CONFIG.mainHost}/${CONFIG.apis.betgameOdds
                    .replace('{optId}', optionId)
                    .replace('{bonus}', followBet.betAmount)}`;
                
                const result = await request(url);
                
                // 成功判断逻辑
                const isSuccess = result.code === 0 || 
                                  (result.code === 1 && result.msg && result.msg.includes("成功")) ||
                                  (result.msg && result.msg.includes("成功")) ||
                                  result.success === true;
                
                if (!isSuccess) {
                    const errorMsg = result.msg || '未知错误';
                    Logger.error(`跟随投注失败: ${errorMsg}`);
                    return false;
                }
                
                Logger.success(`跟随投注成功: 项目 #${followBet.id}，选项 ${followBet.highestOddsTeam}，金额 ${followBet.betAmount}`);
                
                if (!GlobalInfo.bet_mask[followBet.id]) {
                    GlobalInfo.bet_mask[followBet.id] = [];
                }
                GlobalInfo.bet_mask[followBet.id].push(optionId);
                
                return true;
            } catch (e) {
                Logger.warning("主服务器跟随投注失败，尝试备用服务器...");
                try {
                    const url = `${CONFIG.testHost}/${CONFIG.apis.betgameOdds
                        .replace('{optId}', optionId)
                        .replace('{bonus}', followBet.betAmount)}`;
                    
                    const result = await request(url);
                    
                    // 成功判断逻辑
                    const isSuccess = result.code === 0 || 
                                      (result.code === 1 && result.msg && result.msg.includes("成功")) ||
                                      (result.msg && result.msg.includes("成功")) ||
                                      result.success === true;
                    
                    if (!isSuccess) {
                        const errorMsg = result.msg || '未知错误';
                        Logger.error(`备用服务器 - 跟随投注失败: ${errorMsg}`);
                        return false;
                    }
                    
                    Logger.success(`备用服务器 - 跟随投注成功: 项目 #${followBet.id}，选项 ${followBet.highestOddsTeam}，金额 ${followBet.betAmount}`);
                    
                    if (!GlobalInfo.bet_mask[followBet.id]) {
                        GlobalInfo.bet_mask[followBet.id] = [];
                    }
                    GlobalInfo.bet_mask[followBet.id].push(optionId);
                    
                    return true;
                } catch (e2) {
                    Logger.error(`跟随投注请求失败: ${e2.message}`);
                    return false;
                }
            }
        }

        // 获取最高赔率选项
        function getHighestOddsOption(betItem) {
            if (!betItem.optionsList || betItem.optionsList.length === 0) return null;
            
            let highestOdds = -Infinity;
            let highestOption = null;
            
            betItem.optionsList.forEach(option => {
                const odds = parseFloat(option.odds);
                if (odds > highestOdds) {
                    highestOdds = odds;
                    highestOption = option;
                }
            });
            
            return highestOption;
        }

        // 获取押大选项
        async function getLargerOptions(gameId) {
            try {
                const url = `${CONFIG.mainHost}/${CONFIG.apis.get_details.replace('{gameId}', gameId)}`;
                const data = await request(url);
                
                if (!data?.data || !data.data.optionsList) return [];
                
                const options = data.data.optionsList;
                if (options.length > 3) return [];
                
                let minOddsIndex = 0;
                options.forEach((opt, idx) => {
                    if (parseFloat(opt.odds) <= parseFloat(options[minOddsIndex].odds)) {
                        minOddsIndex = idx;
                    }
                });
                
                return options.filter((_, idx) => idx !== minOddsIndex).map(opt => opt.id);
            } catch (e) {
                Logger.error(`获取押大选项失败: ${e.message}`, true);
                return [];
            }
        }

        // 获取押小选项
        async function getSmallerOptions(gameId) {
            try {
                const url = `${CONFIG.mainHost}/${CONFIG.apis.get_details.replace('{gameId}', gameId)}`;
                const data = await request(url);
                
                if (!data?.data || !data.data.optionsList) return [];
                
                const options = data.data.optionsList;
                if (options.length > 3) return [];
                
                let maxOddsIndex = 0;
                options.forEach((opt, idx) => {
                    if (parseFloat(opt.odds) >= parseFloat(options[maxOddsIndex].odds)) {
                        maxOddsIndex = idx;
                    }
                });
                
                return options.filter((_, idx) => idx !== maxOddsIndex).map(opt => opt.id);
            } catch (e) {
                Logger.error(`获取押小选项失败: ${e.message}`, true);
                return [];
            }
        }

        // AI分析模块
        async function analyzeWithAI(betItem) {
            try {
                Logger.info(`开始AI分析项目 #${betItem.id}...`, true);
                
                // 提取队伍信息
                const teams = betItem.optionsList.map(opt => `【AI】${opt.text.trim()}`);
                
                // 获取每支队伍的历史数据
                const teamDataPromises = teams.map(team => fetchTeamHistory(team));
                const teamDataArray = await Promise.all(teamDataPromises);
                
                // 分析数据并预测结果
                const prediction = predictWinner(teamDataArray, teams, betItem);
                
                // 缓存预测结果
                AIAnalytics.predictionCache[betItem.id] = prediction;
                
                Logger.info(`AI分析完成项目 #${betItem.id}: 预测 ${prediction.prediction} (可信度: ${(prediction.confidence * 100).toFixed(1)}%)`, true);
                
                // 更新表格显示
                renderBetTable();
                return prediction;
            } catch (e) {
                Logger.warning(`项目 #${betItem.id} 的AI分析失败: ${e.message}`, true);
                return null;
            }
        }

        // 获取队伍历史数据
        async function fetchTeamHistory(teamName) {
            // 去除AI标识前缀后计算hash
            const pureTeamName = teamName.replace('【AI】', '');
            const teamId = pureTeamName.hashCode();
            
            // 检查缓存
            if (AIAnalytics.historicalData[teamId]) {
                return AIAnalytics.historicalData[teamId];
            }
            
            try {
                // 模拟历史数据
                const mockData = {
                    teamName: teamName,
                    wins: Math.floor(Math.random() * 30) + 10,
                    losses: Math.floor(Math.random() * 20) + 5,
                    recentScores: Array.from({length: 5}, () => ({
                        score: Math.floor(Math.random() * 20) + 50,
                        opponentScore: Math.floor(Math.random() * 20) + 50
                    }))
                };
                
                // 计算胜率
                mockData.winRate = mockData.wins / (mockData.wins + mockData.losses);
                
                // 计算最近5场平均得分差
                mockData.avgScoreDiff = mockData.recentScores.reduce((sum, game) => 
                    sum + (game.score - game.opponentScore), 0) / mockData.recentScores.length;
                
                // 缓存数据
                AIAnalytics.historicalData[teamId] = mockData;
                
                return mockData;
            } catch (e) {
                Logger.warning(`获取队伍 ${teamName} 历史数据失败: ${e.message}`, true);
                return null;
            }
        }

        // 预测获胜者
        function predictWinner(teamDataArray, teamNames, betItem) {
            // 过滤无效数据
            const validData = teamDataArray.filter(data => data !== null);
            if (validData.length < 2) {
                // 数据不足时使用赔率预测
                const highestOddsOption = getHighestOddsOption(betItem);
                const predictionTeam = highestOddsOption ? `【AI】${highestOddsOption.text}` : teamNames[0];
                return {
                    prediction: predictionTeam,
                    confidence: 0.5 // 低可信度
                };
            }
            
            // 计算各队伍的综合得分
            const teamScores = validData.map(data => {
                // 权重：胜率(40%) + 近期表现(30%) + 赔率因素(30%)
                const winRateScore = data.winRate * 0.4;
                
                // 近期表现得分（基于最近得分差）
                const recentFormScore = Math.min(1, Math.max(0, (data.avgScoreDiff + 10) / 20)) * 0.3;
                
                // 找到对应的赔率
                const pureTeamName = data.teamName.replace('【AI】', '');
                const option = betItem.optionsList.find(opt => opt.text.includes(pureTeamName));
                const odds = option ? parseFloat(option.odds) : 1;
                const oddsScore = Math.min(1, 2 / odds) * 0.3; // 赔率越低得分越高
                
                return {
                    teamName: data.teamName,
                    score: winRateScore + recentFormScore + oddsScore
                };
            });
            
            // 找到最高分队伍
            const maxScore = Math.max(...teamScores.map(ts => ts.score));
            const prediction = teamScores.find(ts => ts.score === maxScore).teamName;
            
            // 计算可信度（最高分与次高分的差距）
            const sortedScores = [...teamScores.map(ts => ts.score)].sort((a, b) => b - a);
            const confidence = Math.min(1, 0.5 + (sortedScores[0] - sortedScores[1]) * 2);
            
            return { prediction, confidence };
        }

        // 策略分析逻辑
        function shouldPlaceBet(item) {
            if (!item.optionsList || item.optionsList.length === 0) {
                Logger.warning(`项目 #${item.id} 没有可选项，不参与投注`, true);
                return false;
            }
            
            switch (CONFIG.state.betStrategy) {
                case "larger":
                    const isLargerEligible = item.optionsList.length <= 3;
                    Logger.info(`项目 #${item.id} 押大策略检查: ${isLargerEligible ? '通过' : '不通过'} (选项数量: ${item.optionsList.length})`, true);
                    return isLargerEligible;
                case "smaller":
                    const isSmallerEligible = item.optionsList.length <= 3;
                    Logger.info(`项目 #${item.id} 押小策略检查: ${isSmallerEligible ? '通过' : '不通过'} (选项数量: ${item.optionsList.length})`, true);
                    return isSmallerEligible;
                case "follow":
                    Logger.info(`项目 #${item.id} 跟随策略检查: 通过`, true);
                    return true;
                case "higher_odds":
                    const highestOption = getHighestOddsOption(item);
                    const meetsThreshold = highestOption && parseFloat(highestOption.odds) >= 1.0;
                    Logger.info(`项目 #${item.id} 高赔率策略检查: ${meetsThreshold ? '通过' : '不通过'} (最高赔率: ${highestOption?.odds || 'N/A'})`, true);
                    return meetsThreshold;
                default:
                    return false;
            }
        }

        // 执行投注操作
        async function placeBet(betItem) {
            // 检查是否已获取投注信息
            if (!betItem || !betItem.optionsList || betItem.optionsList.length === 0) {
                showBetResultModal({
                    success: false,
                    betId: betItem?.id || '未知',
                    message: '未获取到有效投注信息，无法执行投注'
                });
                Logger.error(`投注失败: 未获取到项目 #${betItem?.id || '未知'} 的有效投注信息`);
                return false;
            }
            
            updateLastActivity();
            try {
                Logger.info(`开始为项目 #${betItem.id} 下注，策略: ${CONFIG.state.betStrategy}, 金额: ${betItem.betAmount}`);
                
                let choices = [];
                let myBonuses = [];
                let currentOdds = 0;

                if (CONFIG.state.betStrategy === "higher_odds") {
                    const freshBetItem = CONFIG.state.availableBets.find(item => item.id === betItem.id);
                    if (!freshBetItem) {
                        const errorMsg = `项目 #${betItem.id} 已失效`;
                        showBetResultModal({
                            success: false,
                            betId: betItem.id,
                            message: errorMsg
                        });
                        Logger.error(`投注失败: ${errorMsg}`);
                        return false;
                    }
                    
                    // 优先使用AI预测结果
                    const aiPrediction = AIAnalytics.predictionCache[betItem.id];
                    let selectedOption;
                    
                    if (aiPrediction && CONFIG.state.aiPredictionEnabled) {
                        // 去除AI标识匹配原始选项
                        const purePrediction = aiPrediction.prediction.replace('【AI】', '');
                        selectedOption = freshBetItem.optionsList.find(opt => 
                            opt.text.includes(purePrediction)
                        );
                        Logger.info(`使用AI预测结果投注: ${aiPrediction.prediction} (可信度: ${(aiPrediction.confidence * 100).toFixed(1)}%)`, true);
                    }
                    
                    // 如果AI预测没有合适选项，使用最高赔率
                    if (!selectedOption) {
                        selectedOption = getHighestOddsOption(freshBetItem);
                    }
                    
                    if (!selectedOption) {
                        const errorMsg = `未找到有效投注选项`;
                        showBetResultModal({
                            success: false,
                            betId: betItem.id,
                            message: errorMsg
                        });
                        Logger.error(`投注失败: 项目 #${betItem.id} ${errorMsg}`);
                        return false;
                    }
                    
                    currentOdds = parseFloat(selectedOption.odds);
                    choices = [selectedOption.id];
                    myBonuses = [calculateBetAmount()];
                    Logger.info(`投注: 选项 ${selectedOption.text} (赔率: ${selectedOption.odds}), 金额 ${myBonuses[0]}`, true);
                }
                else if (CONFIG.state.betStrategy === "larger") {
                    choices = await getLargerOptions(betItem.id);
                    if (choices.length === 0) {
                        const errorMsg = `没有符合押大策略的选项`;
                        showBetResultModal({
                            success: false,
                            betId: betItem.id,
                            message: errorMsg
                        });
                        Logger.error(`投注失败: 项目 #${betItem.id} ${errorMsg}`);
                        return false;
                    }
                    
                    choices.forEach(() => {
                        myBonuses.push(calculateBetAmount());
                    });
                } 
                else if (CONFIG.state.betStrategy === "smaller") {
                    choices = await getSmallerOptions(betItem.id);
                    if (choices.length === 0) {
                        const errorMsg = `没有符合押小策略的选项`;
                        showBetResultModal({
                            success: false,
                            betId: betItem.id,
                            message: errorMsg
                        });
                        Logger.error(`投注失败: 项目 #${betItem.id} ${errorMsg}`);
                        return false;
                    }
                    
                    choices.forEach(() => {
                        myBonuses.push(calculateBetAmount());
                    });
                }
                
                let allSuccess = true;
                let successOptions = [];
                let failOptions = [];
                
                for (let i = 0; i < choices.length; i++) {
                    const optId = choices[i];
                    const bonus = myBonuses[i];
                    
                    if (GlobalInfo.bet_mask[betItem.id]?.includes(optId)) {
                        Logger.info(`选项 ${optId} 已投注，跳过`, true);
                        continue;
                    }
                    
                    const url = `${CONFIG.mainHost}/${CONFIG.apis.betgameOdds
                        .replace('{optId}', optId)
                        .replace('{bonus}', bonus)}`;
                    
                    const result = await request(url);
                    
                    // 成功判断逻辑
                    const isSuccess = result.code === 0 || 
                                      (result.code === 1 && result.msg && result.msg.includes("成功")) ||
                                      (result.msg && result.msg.includes("成功")) ||
                                      result.success === true;
                    
                    if (!isSuccess) {
                        const errorMsg = result.msg || '未知错误';
                        Logger.error(`项目 #${betItem.id} 选项 ${optId} 投注失败: ${errorMsg}`);
                        failOptions.push({optId, errorMsg});
                        allSuccess = false;
                        continue;
                    }
                    
                    Logger.success(`项目 #${betItem.id} 选项 ${optId} 下注成功`);
                    successOptions.push(optId);
                    
                    if (!GlobalInfo.bet_mask[betItem.id]) {
                        GlobalInfo.bet_mask[betItem.id] = [];
                    }
                    GlobalInfo.bet_mask[betItem.id].push(optId);
                    
                    if (i < choices.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, CONFIG.state.checkInterval * 1000));
                    }
                }
                
                // 显示投注结果弹窗
                showBetResultModal({
                    success: allSuccess,
                    betId: betItem.id,
                    strategy: CONFIG.state.betStrategy,
                    amount: betItem.betAmount,
                    successOptions: successOptions,
                    failOptions: failOptions
                });
                
                if (allSuccess) {
                    Logger.success(`项目 #${betItem.id} 下注成功`);
                    
                    // 投注成功后自动刷新
                    Logger.info(`投注成功，3秒后自动刷新可投注项目...`);
                    setTimeout(() => loadBetItems(), 3000);
                    
                    return true;
                } else {
                    Logger.warning(`项目 #${betItem.id} 部分选项投注失败`);
                    return false;
                }
            } catch (e) {
                Logger.warning("主服务器下注失败，尝试备用服务器...");
                try {
                    let allSuccess = true;
                    let successOptions = [];
                    let failOptions = [];
                    
                    for (let i = 0; i < choices.length; i++) {
                        const optId = choices[i];
                        const bonus = myBonuses[i];
                        
                        if (GlobalInfo.bet_mask[betItem.id]?.includes(optId)) {
                            continue;
                        }
                        
                        const url = `${CONFIG.testHost}/${CONFIG.apis.betgameOdds
                            .replace('{optId}', optId)
                            .replace('{bonus}', bonus)}`;
                        
                        const result = await request(url);
                        
                        // 统一成功判断逻辑（与主服务器保持一致）
                        const isSuccess = result.code === 0 || 
                                          (result.code === 1 && result.msg && result.msg.includes("成功")) ||
                                          (result.msg && result.msg.includes("成功")) ||
                                          result.success === true;
                        
                        if (!isSuccess) {
                            const errorMsg = result.msg || '备用服务器投注失败';
                            Logger.error(`备用服务器 - 项目 #${betItem.id} 选项 ${optId} 投注失败: ${errorMsg}`);
                            failOptions.push({optId, errorMsg});
                            allSuccess = false;
                            continue;
                        }
                        
                        Logger.success(`备用服务器 - 项目 #${betItem.id} 选项 ${optId} 下注成功`);
                        successOptions.push(optId);
                        
                        if (!GlobalInfo.bet_mask[betItem.id]) {
                            GlobalInfo.bet_mask[betItem.id] = [];
                        }
                        GlobalInfo.bet_mask[betItem.id].push(optId);
                        
                        if (i < choices.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, CONFIG.state.checkInterval * 1000));
                        }
                    }
                    
                    // 显示备用服务器投注结果
                    showBetResultModal({
                        success: allSuccess,
                        betId: betItem.id,
                        strategy: CONFIG.state.betStrategy,
                        amount: betItem.betAmount,
                        successOptions: successOptions,
                        failOptions: failOptions,
                        server: 'backup'
                    });
                    
                    if (allSuccess) {
                        Logger.success(`备用服务器 - 项目 #${betItem.id} 下注成功`);
                        Logger.info(`投注成功，3秒后自动刷新可投注项目...`);
                        setTimeout(() => loadBetItems(), 3000);
                        return true;
                    } else {
                        Logger.warning(`备用服务器 - 项目 #${betItem.id} 部分选项投注失败`);
                        return false;
                    }
                } catch (e) {
                    Logger.error(`投注失败: ${e.message}`, e.stack);
                    showBetResultModal({
                        success: false,
                        betId: betItem.id,
                        message: `投注过程发生异常: ${e.message}`
                    });
                    return false;
                }
            }
        }

        // 投注结果弹窗显示函数
        function showBetResultModal(data) {
            // 防止重复打开
            if (isBetModalOpen) return;
            isBetModalOpen = true;
            
            // 获取弹窗元素
            const modal = document.getElementById('betResultModal');
            const titleElement = document.getElementById('betResultTitle');
            const iconElement = document.getElementById('betResultIcon');
            const contentElement = document.getElementById('betResultContent');
            
            // 设置标题和图标
            titleElement.textContent = `${data.success ? '投注成功' : '投注失败'}`;
            titleElement.className = `font-semibold text-xl flex items-center ${data.success ? 'text-success' : 'text-danger'}`;
            iconElement.className = `fa ${data.success ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2 ${data.success ? 'text-success' : 'text-danger'}`;
            
            // 构建内容
            let bodyContent = `<p>项目ID: ${data.betId}</p>`;
            if (data.strategy) bodyContent += `<p>投注策略: ${formatStrategyName(data.strategy)}</p>`;
            if (data.amount) bodyContent += `<p>投注金额: ${data.amount}</p>`;
            if (data.option) bodyContent += `<p>投注选项: ${data.option}</p>`;
            if (data.server) bodyContent += `<p>使用服务器: ${data.server === 'backup' ? '备用服务器' : '主服务器'}</p>`;
            
            // 成功选项列表
            if (data.successOptions && data.successOptions.length > 0) {
                bodyContent += `<p><strong>成功选项:</strong> ${data.successOptions.join(', ')}</p>`;
            }
            
            // 失败选项及原因
            if (data.failOptions && data.failOptions.length > 0) {
                bodyContent += `<p><strong>失败选项:</strong></p><ul>`;
                data.failOptions.forEach(item => {
                    bodyContent += `<li>选项 ${item.optId}: ${item.errorMsg}</li>`;
                });
                bodyContent += `</ul>`;
            }
            
            // 自定义消息
            if (data.message) {
                bodyContent += `<p>${data.message}</p>`;
            }
            
            contentElement.innerHTML = bodyContent;
            
            // 显示弹窗
            modal.style.display = 'flex';
            
            // 5秒后自动关闭弹窗（成功状态）
            if (data.success) {
                setTimeout(() => {
                    closeBetResultModal();
                }, 5000);
            }
        }

        // 关闭投注结果弹窗
        function closeBetResultModal() {
            const modal = document.getElementById('betResultModal');
            modal.style.display = 'none';
            isBetModalOpen = false;
        }

        // 辅助函数：格式化策略名称显示
        function formatStrategyName(strategy) {
            const strategyMap = {
                'higher_odds': '高赔率优先',
                'larger': '押大策略',
                'smaller': '押小策略',
                'follow': '跟随目标用户'
            };
            return strategyMap[strategy] || strategy;
        }

        // 启动服务
        async function startService() {
            if (isServiceRunning) {
                Logger.warning("服务已在运行中");
                return;
            }
            
            // 验证API Key
            const apiValid = await verifyApiKey();
            if (!apiValid) {
                return;
            }
            
            // 更新服务状态
            isServiceRunning = true;
            document.getElementById('serviceStatusIndicator').className = 'inline-block w-3 h-3 rounded-full bg-success mr-2';
            document.getElementById('serviceStatusText').textContent = '服务运行中';
            document.getElementById('startServiceBtn').disabled = true;
            document.getElementById('startServiceBtn').className = 'flex-1 bg-success hover:bg-success/90 text-white px-4 py-2 rounded-lg transition hover-lift opacity-50 cursor-not-allowed';
            document.getElementById('stopServiceBtn').disabled = false;
            document.getElementById('stopServiceBtn').className = 'flex-1 bg-danger hover:bg-danger/90 text-white px-4 py-2 rounded-lg transition hover-lift';
            
            Logger.success("服务已启动");
            
            // 加载投注项目
            await loadBetItems();
            
            // 启动自动刷新
            startAutoRefresh();
            
            // 启动投注检查定时器
            startBetCheckTimer();
            
            // 启动定时任务检查
            startScheduleCheckers();
        }

        // 停止服务
        function stopService() {
            if (!isServiceRunning) {
                Logger.warning("服务未在运行中");
                return;
            }
            
            // 清除所有定时器
            stopAutoRefresh();
            stopBetCheckTimer();
            stopFollowingChecks();
            stopScheduleCheckers();
            
            // 更新服务状态
            isServiceRunning = false;
            document.getElementById('serviceStatusIndicator').className = 'inline-block w-3 h-3 rounded-full bg-gray-400 mr-2';
            document.getElementById('serviceStatusText').textContent = '服务未运行';
            document.getElementById('startServiceBtn').disabled = false;
            document.getElementById('startServiceBtn').className = 'flex-1 bg-success hover:bg-success/90 text-white px-4 py-2 rounded-lg transition hover-lift';
            document.getElementById('stopServiceBtn').disabled = true;
            document.getElementById('stopServiceBtn').className = 'flex-1 bg-danger hover:bg-danger/90 text-white px-4 py-2 rounded-lg transition hover-lift opacity-50 cursor-not-allowed';
            
            Logger.success("服务已停止");
        }

        // 手动刷新
        async function manualRefresh() {
            Logger.info("执行手动刷新...");
            await loadBetItems();
        }

        // 切换自动刷新
        function toggleAutoRefresh() {
            CONFIG.state.autoRefresh = !CONFIG.state.autoRefresh;
            const btn = document.getElementById('autoRefreshBtn');
            
            if (CONFIG.state.autoRefresh) {
                btn.innerHTML = '<i class="fa fa-refresh mr-1"></i> 关闭自动刷新';
                Logger.info("已开启自动刷新");
                if (isServiceRunning) {
                    startAutoRefresh();
                }
            } else {
                btn.innerHTML = '<i class="fa fa-refresh mr-1"></i> 开启自动刷新';
                Logger.info("已关闭自动刷新");
                stopAutoRefresh();
            }
        }

        // 启动自动刷新
        function startAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
            }
            
            // 立即执行一次
            updateRefreshIntervalDisplay();
            
            // 设置定时器
            autoRefreshTimer = setInterval(() => {
                if (!isPageVisible) return;
                
                const now = new Date().getTime();
                const elapsed = now - refreshCycleStartTime;
                const intervalMs = CONFIG.state.refreshInterval * 1000;
                
                if (elapsed >= intervalMs) {
                    loadBetItems();
                } else {
                    updateRefreshIntervalDisplay();
                }
            }, 100);
            
            Logger.info(`自动刷新已启动 (间隔: ${CONFIG.state.refreshInterval}秒)`);
        }

        // 停止自动刷新
        function stopAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
            }
        }

        // 重置刷新周期
        function resetRefreshCycle() {
            refreshCycleStartTime = new Date().getTime();
            updateRefreshIntervalDisplay();
        }

        // 更新刷新间隔显示
        function updateRefreshIntervalDisplay() {
            const now = new Date().getTime();
            const elapsed = now - refreshCycleStartTime;
            const intervalMs = CONFIG.state.refreshInterval * 1000;
            const remaining = Math.max(0, intervalMs - elapsed);
            
            const hours = Math.floor(remaining / 3600000);
            const minutes = Math.floor((remaining % 3600000) / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);
            const milliseconds = Math.floor(remaining % 1000);
            
            const displayText = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(3, '0')}`;
            document.getElementById('refreshIntervalDisplay').textContent = displayText;
        }

        // 启动投注检查定时器
        function startBetCheckTimer() {
            if (betCheckTimer) {
                clearInterval(betCheckTimer);
            }
            
            betCheckTimer = setInterval(() => {
                if (!isServiceRunning || !isPageVisible) return;
                
                const now = new Date();
                const betsToPlace = pendingBets.filter(bet => 
                    bet.status === "等待中" && bet.betTime <= now
                );
                
                if (betsToPlace.length > 0) {
                    Logger.info(`检测到 ${betsToPlace.length} 个需要投注的项目，准备执行投注`, true);
                    
                    betsToPlace.forEach(bet => {
                        const index = pendingBets.findIndex(b => b.id === bet.id && b.status === "等待中");
                        if (index !== -1) {
                            pendingBets[index].status = "处理中";
                        }
                        
                        // 执行投注
                        placeBet(bet).then(success => {
                            const updateIndex = pendingBets.findIndex(b => b.id === bet.id && b.status === "处理中");
                            if (updateIndex !== -1) {
                                pendingBets[updateIndex].status = success ? "已完成" : "失败";
                                renderPendingBetsTable();
                            }
                        });
                    });
                    
                    renderPendingBetsTable();
                }
                
                // 定期清理已结束的项目
                processPendingBets();
            }, CONFIG.state.checkInterval * 1000);
            
            Logger.info(`投注检查定时器已启动 (检查间隔: ${CONFIG.state.checkInterval}秒)`);
        }

        // 停止投注检查定时器
        function stopBetCheckTimer() {
            if (betCheckTimer) {
                clearInterval(betCheckTimer);
                betCheckTimer = null;
            }
        }

        // 停止所有跟随检查
        function stopFollowingChecks() {
            Object.values(followCheckTimers).forEach(timer => {
                clearInterval(timer);
            });
            followCheckTimers = {};
        }

        // 启动定时任务检查器
        function startScheduleCheckers() {
            // 清除已有定时器
            stopScheduleCheckers();
            
            // 第一组定时任务检查器
            scheduleTimers.check1 = setInterval(() => {
                checkSchedule(1);
            }, 60000); // 每分钟检查一次
            
            // 第二组定时任务检查器
            scheduleTimers.check2 = setInterval(() => {
                checkSchedule(2);
            }, 60000); // 每分钟检查一次
            
            Logger.info("定时任务检查器已启动");
            
            // 立即检查一次
            checkSchedule(1);
            checkSchedule(2);
        }

        // 停止定时任务检查器
        function stopScheduleCheckers() {
            if (scheduleTimers.check1) {
                clearInterval(scheduleTimers.check1);
                scheduleTimers.check1 = null;
            }
            
            if (scheduleTimers.check2) {
                clearInterval(scheduleTimers.check2);
                scheduleTimers.check2 = null;
            }
        }

        // 检查定时任务状态
        function checkSchedule(scheduleNumber) {
            const enabled = scheduleNumber === 1 ? CONFIG.state.schedule1Enabled : CONFIG.state.schedule2Enabled;
            if (!enabled) return;
            
            const startTime = scheduleNumber === 1 ? CONFIG.state.schedule1StartTime : CONFIG.state.schedule2StartTime;
            const stopTime = scheduleNumber === 1 ? CONFIG.state.schedule1StopTime : CONFIG.state.schedule2StopTime;
            
            const [startHours, startMinutes] = startTime.split(':').map(Number);
            const [stopHours, stopMinutes] = stopTime.split(':').map(Number);
            
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const startTotalMinutes = startHours * 60 + startMinutes;
            const stopTotalMinutes = stopHours * 60 + stopMinutes;
            
            let isInSchedule = false;
            
            if (startTotalMinutes <= stopTotalMinutes) {
                // 时间段在同一天内
                isInSchedule = currentMinutes >= startTotalMinutes && currentMinutes <= stopTotalMinutes;
            } else {
                // 时间段跨天（如23:00到06:00）
                isInSchedule = currentMinutes >= startTotalMinutes || currentMinutes <= stopTotalMinutes;
            }
            
            // 根据时间调整服务状态
            if (isInSchedule && !isServiceRunning) {
                Logger.info(`定时任务 ${scheduleNumber} 触发：启动服务`);
                startService();
            } else if (!isInSchedule && isServiceRunning) {
                Logger.info(`定时任务 ${scheduleNumber} 触发：停止服务`);
                stopService();
            }
        }

        // 切换日志弹窗
        function toggleLogModal() {
            const modal = document.getElementById('logModal');
            logModalVisible = !logModalVisible;
            
            if (logModalVisible) {
                modal.classList.remove('hidden');
                Logger.render(); // 刷新日志显示
            } else {
                modal.classList.add('hidden');
            }
        }

        // 保存配置参数
        function saveParameters() {
            try {
                // 保存基本配置
                CONFIG.state.targetUserId = document.getElementById('targetUserIdInput').value;
                CONFIG.state.betStrategy = document.getElementById('betStrategySelect').value;
                CONFIG.state.advanceSeconds = parseInt(document.getElementById('advanceSecondsInput').value) || 3;
                
                // 保存金额设置
                CONFIG.state.baseAmount = parseInt(document.getElementById('baseAmountInput').value) || 10000;
                
                // 保存刷新设置
                const hours = parseInt(document.getElementById('refreshHoursInput').value) || 0;
                const minutes = parseInt(document.getElementById('refreshMinutesInput').value) || 0;
                const seconds = parseInt(document.getElementById('refreshSecondsInput').value) || 30;
                CONFIG.state.refreshInterval = hours * 3600 + minutes * 60 + seconds;
                
                CONFIG.state.checkInterval = parseFloat(document.getElementById('checkIntervalInput').value) || 2;
                CONFIG.state.followCheckInterval = parseInt(document.getElementById('followCheckIntervalInput').value) || 500;
                
                // 保存定时任务设置
                CONFIG.state.schedule1Enabled = document.getElementById('schedule1EnabledCheckbox').checked;
                CONFIG.state.schedule1StartTime = document.getElementById('schedule1StartTimeInput').value;
                CONFIG.state.schedule1StopTime = document.getElementById('schedule1StopTimeInput').value;
                
                CONFIG.state.schedule2Enabled = document.getElementById('schedule2EnabledCheckbox').checked;
                CONFIG.state.schedule2StartTime = document.getElementById('schedule2StartTimeInput').value;
                CONFIG.state.schedule2StopTime = document.getElementById('schedule2StopTimeInput').value;
                
                // 保存其他设置
                CONFIG.state.pendingFilter = document.getElementById('pendingFilterSelect').value;
                CONFIG.state.detailedLogMode = document.getElementById('detailedLogModeCheckbox').checked;
                CONFIG.state.aiPredictionEnabled = document.getElementById('aiPredictionEnabledCheckbox').checked;
                
                // 更新日志模式
                Logger.toggleDetailedMode(CONFIG.state.detailedLogMode);
                
                // 如果服务正在运行，重启自动刷新以应用新的间隔
                if (isServiceRunning) {
                    startAutoRefresh();
                    startBetCheckTimer();
                }
                
                Logger.success("配置已保存");
                return true;
            } catch (e) {
                Logger.error(`保存配置失败: ${e.message}`);
                return false;
            }
        }

        // 更新最后活动时间
        function updateLastActivity() {
            lastActivityTime = new Date().getTime();
        }

        // 渲染投注项目表格
        function renderBetTable() {
            const table = document.getElementById('betItemsTable');
            if (!table) return;
            
            if (CONFIG.state.availableBets.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="7" class="border border-gray-200 p-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i class="fa fa-inbox text-3xl mb-2 text-gray-300"></i>
                                <span>暂无可用投注项目</span>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">项目名称</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">选项</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">结束时间</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AI预测</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            CONFIG.state.availableBets.forEach(betItem => {
                // 检查是否已投注
                const isBet = GlobalInfo.bet_mask[betItem.id] && GlobalInfo.bet_mask[betItem.id].length > 0;
                
                // 获取最高赔率选项
                const highestOption = getHighestOddsOption(betItem);
                
                // 获取AI预测
                const aiPrediction = AIAnalytics.predictionCache[betItem.id];
                
                // 格式化结束时间
                const endTime = new Date(betItem.endtime);
                const formattedEndTime = endTime.toLocaleString('zh-CN');
                
                // 构建选项HTML
                let optionsHtml = '';
                betItem.optionsList.forEach(option => {
                    const isHighest = highestOption && option.id === highestOption.id;
                    optionsHtml += `<div class="${isHighest ? 'odds-highlight' : ''} px-1">${option.text} (${option.odds})</div>`;
                });
                
                html += `
                    <tr class="table-hover-row">
                        <td class="px-4 py-3 whitespace-nowrap text-sm">${betItem.id}</td>
                        <td class="px-4 py-3 text-sm">${betItem.heading || '无标题'}</td>
                        <td class="px-4 py-3 text-sm">${optionsHtml}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">${formattedEndTime}</td>
                        <td class="px-4 py-3 text-sm ${aiPrediction ? 'text-purple' : ''}">
                            ${aiPrediction ? aiPrediction.prediction : '未分析'}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${isBet ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                ${isBet ? '已投注' : '可投注'}
                            </span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">
                            <button onclick="placeBet(${JSON.stringify(betItem).replace(/"/g, '&quot;')})" 
                                    class="text-primary hover:text-primary/80 ${isBet ? 'opacity-50 cursor-not-allowed' : ''}"
                                    ${isBet ? 'disabled' : ''}>
                                ${isBet ? '已投注' : '立即投注'}
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `</tbody>`;
            table.innerHTML = html;
        }

        // 渲染待投注项目表格
        function renderPendingBetsTable() {
            const table = document.getElementById('pendingBetsTable');
            if (!table) return;
            
            if (pendingBets.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="7" class="border border-gray-200 p-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i class="fa fa-hourglass-o text-3xl mb-2 text-gray-300"></i>
                                <span>暂无待投注项目</span>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">项目名称</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">投注选项</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">投注时间</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金额</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">策略</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            pendingBets.forEach(bet => {
                // 格式化投注时间
                const betTime = new Date(bet.betTime);
                const formattedBetTime = betTime.toLocaleString('zh-CN');
                
                // 状态样式
                let statusClass = '';
                let statusText = '';
                
                switch (bet.status) {
                    case "等待中":
                        statusClass = 'bg-yellow-100 text-yellow-800';
                        statusText = '等待中';
                        break;
                    case "处理中":
                        statusClass = 'bg-blue-100 text-blue-800';
                        statusText = '处理中';
                        break;
                    case "已完成":
                        statusClass = 'bg-green-100 text-green-800';
                        statusText = '已完成';
                        break;
                    case "失败":
                        statusClass = 'bg-red-100 text-red-800';
                        statusText = '失败';
                        break;
                }
                
                html += `
                    <tr class="table-hover-row">
                        <td class="px-4 py-3 whitespace-nowrap text-sm">${bet.id}</td>
                        <td class="px-4 py-3 text-sm">${bet.heading || '无标题'}</td>
                        <td class="px-4 py-3 text-sm">${bet.highestOddsTeam || 'N/A'} (${bet.highestOdds})</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">${formattedBetTime}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">${bet.betAmount}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">${formatStrategyName(bet.strategy)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += `</tbody>`;
            table.innerHTML = html;
        }

        // 页面加载完成初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化日志
            Logger.info("系统已加载，等待启动服务...");
            
            // 初始化页面可见性监听
            document.addEventListener('visibilitychange', function() {
                isPageVisible = !document.hidden;
                if (isPageVisible && isServiceRunning) {
                    Logger.info("页面恢复可见，继续自动操作", true);
                } else if (!isPageVisible && isServiceRunning) {
                    Logger.info("页面不可见，暂停自动操作", true);
                }
            });
            
            // 初始化表格
            renderBetTable();
            renderPendingBetsTable();
        });
    </script>
</body>
</html>
