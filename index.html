<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M-Team 投注系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        success: '#52C41A',
                        warning: '#FAAD14',
                        danger: '#FF4D4F',
                        dark: '#1F2937',
                        light: '#F9FAFB',
                        purple: '#7B61FF'
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            }
            .hover-lift {
                transition: transform 0.2s, box-shadow 0.2s;
            }
            .hover-lift:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
            }
        }
    </style>
    <script>
        // 全局变量和配置
        const CONFIG = {
            mainHost: "https://api.m-team.io/api",
            testHost: "https://test2.m-team.cc/api",
            apis: {
                "get_current_bet": "bet/findBetgameList?active=LIVE&fix=0",
                "betgameOdds": "bet/betgameOdds?optId={optId}&bonus={bonus}",
                "get_details": "bet/getDetail?gameId={gameId}",
                "get_gamblers": "bet/getDetailBetList?gameId={gameId}",
                "get_my_bet_log": "bet/myCouponLog"
            },
            state: {
                availableBets: [],
                autoRefresh: true,
                refreshInterval: 30, // 秒
                refreshIntervalMs: 0, // 毫秒
                targetUserId: "205809",
                advanceSeconds: 3,
                toleranceSeconds: 10,
                amountRange: 20000,
                baseAmount: 10000,
                betStrategy: "higher_odds",
                checkInterval: 2,
                detailedLogMode: false,
                oddsThreshold: 1.5,
                pendingFilter: "all",
                slippageTolerance: 0.05,
                followCheckInterval: 500, // 毫秒
                followCheckIntervalSec: 0, // 秒
                aiRefreshInterval: 1000, // AI后台刷新间隔(毫秒)
                autoBetTriggerSec: 30 // 自动下注触发时间(秒)
            }
        };

        // 全局状态
        let isServiceRunning = false;
        let pendingBets = [];
        let autoRefreshTimer = null;
        let betCheckTimer = null;
        let followCheckTimers = {};
        let aiRefreshTimers = {};
        let lastActivityTime = 0;
        let isPageVisible = true;
        let refreshCycleStartTime = 0;
        
        // 日志系统
        const Logger = {
            logs: [],
            detailedMode: false,
            log(content, level = "INFO", detailed = false) {
                if (detailed && !this.detailedMode) return;
                
                const now = new Date().toLocaleString("zh-CN", {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    fractionalSecondDigits: 3
                });
                const logItem = `[${now}] [${level}] ${content}`;
                this.logs.unshift(logItem);
                if (this.logs.length > 500) this.logs.pop();
                this.render();
            },
            info(content, detailed = false) { this.log(content, "INFO", detailed); },
            error(content, detailed = false) { this.log(content, "ERROR", detailed); },
            warning(content, detailed = false) { this.log(content, "WARN", detailed); },
            clear() {
                this.logs = [];
                this.render();
                this.info("日志已清空");
            },
            render() {
                const panel = document.getElementById('logPanel');
                if (panel) {
                    panel.innerHTML = this.logs.map(log => 
                        `<div class="py-1 ${log.includes('ERROR') ? 'text-danger' : log.includes('WARN') ? 'text-warning' : ''}">${log}</div>`
                    ).join("");
                    panel.scrollTop = panel.scrollHeight;
                }
            }
        };

        // 核心请求函数
        async function request(url, method = 'post', data = {}, retry = 1) {
            try {
                const response = await axios({
                    method,
                    url,
                    data,
                    headers: {
                        "x-api-key": document.getElementById("apiKeyInput").value || "",
                        "Content-Type": "application/json"
                    },
                    timeout: 15000
                });
                Logger.info(`请求成功: ${url}`, true);
                return response.data;
            } catch (e) {
                Logger.error(`请求失败: ${e.message} (${url})`, true);
                if (retry > 0) {
                    Logger.warning(`尝试重试请求: ${url}`, true);
                    return request(url, method, data, retry - 1);
                }
                throw new Error(`请求失败: ${e.message}`);
            }
        }

        // API验证
        async function verifyApiKey() {
            const apiKey = document.getElementById("apiKeyInput").value;
            if (!apiKey) {
                Logger.warning("请输入API Key");
                return false;
            }

            try {
                Logger.info("正在验证API Key...");
                const result = await request(`${CONFIG.mainHost}/${CONFIG.apis.get_current_bet}`);
                if (result && (result.data || result.code === 0)) {
                    Logger.info("API Key验证成功");
                    return true;
                } else {
                    Logger.error(`API Key验证失败`);
                    return false;
                }
            } catch (e) {
                Logger.warning("主服务器验证失败，尝试备用服务器...");
                try {
                    const result = await request(`${CONFIG.testHost}/${CONFIG.apis.get_current_bet}`);
                    if (result && (result.data || result.code === 0)) {
                        Logger.info("备用服务器API Key验证成功");
                        return true;
                    } else {
                        Logger.error(`备用服务器API Key验证失败`);
                        return false;
                    }
                } catch (e2) {
                    Logger.error(`API Key验证失败: ${e2.message}`);
                    return false;
                }
            }
        }

        // 获取可投注项目
        async function loadBetItems() {
            updateLastActivity();
            try {
                Logger.info("正在获取可投注项目...");
                const data = await request(`${CONFIG.mainHost}/${CONFIG.apis.get_current_bet}`);
                CONFIG.state.availableBets = Array.isArray(data?.data) ? data.data : [];
                
                Logger.info(`找到可下注项目（${CONFIG.state.availableBets.length} 个）`);
                
                // 启动AI后台刷新（非跟随模式）
                if (CONFIG.state.betStrategy !== "follow") {
                    CONFIG.state.availableBets.forEach(bet => {
                        startAIRefresh(bet.id);
                    });
                }
                
                processPendingBets(true);
                renderBetTable();
                resetRefreshCycle();
                return true;
            } catch (e) {
                Logger.warning("主服务器获取失败，尝试备用服务器...");
                try {
                    const data = await request(`${CONFIG.testHost}/${CONFIG.apis.get_current_bet}`);
                    CONFIG.state.availableBets = Array.isArray(data?.data) ? data.data : [];
                    
                    Logger.info(`从备用服务器找到可下注项目（${CONFIG.state.availableBets.length} 个）`);
                    
                    // 启动AI后台刷新（非跟随模式）
                    if (CONFIG.state.betStrategy !== "follow") {
                        CONFIG.state.availableBets.forEach(bet => {
                            startAIRefresh(bet.id);
                        });
                    }
                    
                    processPendingBets(true);
                    renderBetTable();
                    resetRefreshCycle();
                    return true;
                } catch (e2) {
                    Logger.error(`获取投注项目失败: ${e2.message}`);
                    resetRefreshCycle();
                    return false;
                }
            }
        }

        // AI后台实时刷新队伍胜率/比分
        function startAIRefresh(gameId) {
            if (aiRefreshTimers[gameId]) {
                clearInterval(aiRefreshTimers[gameId]);
            }
            
            Logger.info(`启动项目 #${gameId} 的AI后台刷新 (间隔: ${CONFIG.state.aiRefreshInterval}ms)`, true);
            
            aiRefreshTimers[gameId] = setInterval(async () => {
                if (!isServiceRunning) {
                    clearInterval(aiRefreshTimers[gameId]);
                    delete aiRefreshTimers[gameId];
                    return;
                }
                
                // 检查项目是否仍然有效
                const betItem = CONFIG.state.availableBets.find(item => item.id === gameId);
                if (!betItem) {
                    clearInterval(aiRefreshTimers[gameId]);
                    delete aiRefreshTimers[gameId];
                    Logger.info(`项目 #${gameId} 已失效，停止AI刷新`, true);
                    return;
                }
                
                // 模拟AI测算（实际项目中需对接真实AI接口）
                const winRate = (50 + Math.random() * 40).toFixed(1);
                const homeScore = Math.floor(Math.random() * 3);
                const awayScore = Math.floor(Math.random() * 2);
                
                // 存储测算结果（实际项目中需持久化）
                betItem.aiWinRate = parseFloat(winRate);
                betItem.aiScore = `${homeScore}-${awayScore}`;
                
                // 最后30秒自动触发下注
                const endTime = new Date(betItem.endtime);
                const now = new Date();
                const remainingSec = Math.max(0, Math.floor((endTime - now) / 1000));
                
                if (remainingSec <= CONFIG.state.autoBetTriggerSec && !pendingBets.some(bet => bet.id === gameId)) {
                    Logger.info(`项目 #${gameId} 进入最后${CONFIG.state.autoBetTriggerSec}秒，触发自动下注`, true);
                    pendingBets.push({
                        ...betItem,
                        status: "等待中",
                        betTime: new Date(),
                        betAmount: calculateBetAmount(),
                        highestOddsTeam: getHighestOddsOption(betItem)?.text || "未知",
                        highestOdds: getHighestOddsOption(betItem)?.odds || 0
                    });
                    renderPendingBetsTable();
                    checkAndPlaceBets();
                }
            }, CONFIG.state.aiRefreshInterval);
        }

        // 计算投注金额
        function calculateBetAmount() {
            if (CONFIG.state.amountRange <= 0) return CONFIG.state.baseAmount;
            const randomOffset = Math.floor(Math.random() * (CONFIG.state.amountRange * 2 + 1)) - CONFIG.state.amountRange;
            return Math.max(CONFIG.state.baseAmount + randomOffset, 100);
        }

        // 获取最高赔率选项
        function getHighestOddsOption(betItem) {
            if (!betItem.optionsList || betItem.optionsList.length === 0) return null;
            
            let highestOdds = -Infinity;
            let highestOption = null;
            
            betItem.optionsList.forEach(option => {
                const odds = parseFloat(option.odds);
                if (odds > highestOdds) {
                    highestOdds = odds;
                    highestOption = option;
                }
            });
            
            return highestOption;
        }

        // 处理待投注项目
        function processPendingBets(refresh = false) {
            const now = new Date();
            const processingItems = refresh ? pendingBets.filter(bet => bet.status === "处理中") : [];
            let newPendingBets = [...processingItems];
            
            renderPendingBetsTable();
        }

        // 开始跟随检查
        function startFollowingCheck(gameId) {
            if (followCheckTimers[gameId]) {
                clearInterval(followCheckTimers[gameId]);
            }
            
            const checkInterval = CONFIG.state.followCheckInterval;
            Logger.info(`开始监控项目 #${gameId} 的目标用户投注 (检查间隔: ${checkInterval}ms)`, true);
            
            followCheckTimers[gameId] = setInterval(async () => {
                if (!isServiceRunning) {
                    clearInterval(followCheckTimers[gameId]);
                    delete followCheckTimers[gameId];
                    return;
                }
                
                // 检查项目是否仍然有效
                const betItem = CONFIG.state.availableBets.find(item => item.id === gameId);
                if (!betItem) {
                    clearInterval(followCheckTimers[gameId]);
                    delete followCheckTimers[gameId];
                    Logger.info(`项目 #${gameId} 已失效，停止监控`, true);
                    return;
                }
                
                // 获取目标用户投注
                const targetBet = await getTargetUserBet(gameId);
                if (targetBet) {
                    // 立即执行跟随投注
                    const followBet = {
                        ...betItem,
                        id: gameId,
                        betTime: new Date(),
                        betAmount: calculateFollowAmount(targetBet.bonus),
                        strategy: "follow",
                        status: "处理中",
                        highestOddsTeam: betItem.optionsList.find(opt => opt.id === targetBet.optionid)?.text || "未知",
                        highestOdds: parseFloat(betItem.optionsList.find(opt => opt.id === targetBet.optionid)?.odds || 0),
                        recordedOdds: 0
                    };
                    
                    pendingBets.unshift(followBet);
                    renderPendingBetsTable();
                    
                    // 执行投注
                    const success = await placeBet(followBet, targetBet.optionid);
                    
                    // 更新状态
                    const index = pendingBets.findIndex(b => b.id === gameId && b.status === "处理中");
                    if (index !== -1) {
                        pendingBets[index].status = success ? "已完成" : "失败";
                        renderPendingBetsTable();
                    }
                    
                    // 停止监控
                    clearInterval(followCheckTimers[gameId]);
                    delete followCheckTimers[gameId];
                }
            }, checkInterval);
        }

        // 计算跟随金额
        function calculateFollowAmount(baseAmount) {
            const base = parseInt(baseAmount) || 0;
            const bias = Math.floor(Math.random() * (CONFIG.state.amountRange * 2 + 1)) - CONFIG.state.amountRange;
            return Math.max(base + bias, 100);
        }

        // 获取目标用户的投注记录
        async function getTargetUserBet(gameId) {
            try {
                Logger.info(`尝试获取目标用户 ${CONFIG.state.targetUserId} 的投注记录 (项目 #${gameId})`, true);
                const url = `${CONFIG.mainHost}/${CONFIG.apis.get_gamblers.replace('{gameId}', gameId)}`;
                const data = await request(url);
                
                if (data?.data && Array.isArray(data.data)) {
                    const targetBet = data.data.find(log => log.userid === CONFIG.state.targetUserId);
                    if (targetBet) {
                        Logger.info(`找到目标用户 ${CONFIG.state.targetUserId} 的投注记录: 选项 ${targetBet.optionid}, 金额 ${targetBet.bonus}`, true);
                    } else {
                        Logger.info(`未找到目标用户 ${CONFIG.state.targetUserId} 的投注记录`, true);
                    }
                    return targetBet;
                }
                return null;
            } catch (e) {
                Logger.warning(`获取用户投注记录失败: ${e.message}，尝试备用服务器`, true);
                try {
                    const url = `${CONFIG.testHost}/${CONFIG.apis.get_gamblers.replace('{gameId}', gameId)}`;
                    const data = await request(url);
                    
                    if (data?.data && Array.isArray(data.data)) {
                        const targetBet = data.data.find(log => log.userid === CONFIG.state.targetUserId);
                        return targetBet;
                    }
                    return null;
                } catch (e2) {
                    Logger.error(`获取用户投注记录失败: ${e2.message}`, true);
                    return null;
                }
            }
        }

        // 执行投注
        async function placeBet(betItem, optionId) {
            updateLastActivity();
            try {
                Logger.info(`开始为项目 #${betItem.id} 下注，金额: ${betItem.betAmount}`);
                
                const url = `${CONFIG.mainHost}/${CONFIG.apis.betgameOdds
                    .replace('{optId}', optionId)
                    .replace('{bonus}', betItem.betAmount)}`;
                
                const result = await request(url);
                
                if (result.code !== 0) {
                    Logger.error(`项目 #${betItem.id} 投注失败（滑点）: ${result.msg || '未知错误'}`);
                    return false;
                }
                
                Logger.info(`项目 #${betItem.id} 下注成功`);
                return true;
            } catch (e) {
                Logger.warning("主服务器下注失败，尝试备用服务器...");
                try {
                    const url = `${CONFIG.testHost}/${CONFIG.apis.betgameOdds
                        .replace('{optId}', optionId)
                        .replace('{bonus}', betItem.betAmount)}`;
                    
                    const result = await request(url);
                    
                    if (result.code !== 0) {
                        Logger.error(`备用服务器 - 项目 #${betItem.id} 投注失败: ${result.msg || '未知错误'}`);
                        return false;
                    }
                    
                    Logger.info(`备用服务器 - 项目 #${betItem.id} 下注成功`);
                    return true;
                } catch (e2) {
                    Logger.error(`项目 #${betItem.id} 下注请求失败: ${e2.message}`);
                    return false;
                }
            }
        }

        // 检查并执行待下注
        function checkAndPlaceBets() {
            if (!isServiceRunning) return;
            
            updateLastActivity();
            const now = new Date();
            Logger.info("正在检查待下注项目...", true);
            
            pendingBets.forEach(bet => {
                if (now >= new Date(bet.betTime) && bet.status === "等待中") {
                    bet.status = "处理中";
                    renderPendingBetsTable();
                    
                    (async () => {
                        let optionId = "";
                        if (CONFIG.state.betStrategy === "higher_odds") {
                            const highestOption = getHighestOddsOption(bet);
                            optionId = highestOption ? highestOption.id : "";
                        } else if (CONFIG.state.betStrategy === "follow") {
                            // 跟随模式已在监控时处理
                            return;
                        }
                        
                        const success = await placeBet(bet, optionId);
                        bet.status = success ? "已完成" : "失败";
                        renderPendingBetsTable();
                    })();
                }
            });
            
            if (isServiceRunning) {
                betCheckTimer = setTimeout(checkAndPlaceBets, CONFIG.state.checkInterval * 1000);
            }
        }

        // 服务控制
        async function startService() {
            if (isServiceRunning) {
                Logger.warning("服务已在运行中");
                return;
            }
            
            const apiValid = await verifyApiKey();
            if (!apiValid) {
                Logger.error("API Key验证失败，无法启动服务");
                return;
            }
            
            saveParameters();
            await loadBetItems();
            startAutoRefresh();
            startBetChecker();
            
            resetRefreshCycle();
            
            isPageVisible = true;
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            isServiceRunning = true;
            updateServiceStatus();
            Logger.info("服务已启动");
        }

        function stopService() {
            if (!isServiceRunning) {
                Logger.warning("服务未在运行中");
                return;
            }
            
            // 清除所有定时器
            Object.values(followCheckTimers).forEach(timer => clearInterval(timer));
            Object.values(aiRefreshTimers).forEach(timer => clearInterval(timer));
            followCheckTimers = {};
            aiRefreshTimers = {};
            
            stopAutoRefresh();
            stopBetChecker();
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            
            isServiceRunning = false;
            updateServiceStatus();
            Logger.info("服务已停止");
        }

        // 自动刷新控制
        function startAutoRefresh() {
            stopAutoRefresh();
            
            const refresh = () => {
                if (CONFIG.state.autoRefresh && isServiceRunning) {
                    loadBetItems();
                }
                
                if (isServiceRunning && CONFIG.state.autoRefresh) {
                    scheduleNextRefresh();
                }
            };
            
            refresh();
        }

        function scheduleNextRefresh() {
            const now = Date.now();
            const intervalMs = (CONFIG.state.refreshInterval * 1000) + CONFIG.state.refreshIntervalMs;
            const nextRefreshTime = refreshCycleStartTime + intervalMs;
            const delay = Math.max(0, nextRefreshTime - now);
            
            autoRefreshTimer = setTimeout(() => {
                if (isServiceRunning && CONFIG.state.autoRefresh) {
                    loadBetItems();
                }
            }, delay);
            
            const nextTime = new Date(nextRefreshTime);
            Logger.info(`下一次数据刷新时间: ${nextTime.toLocaleTimeString("zh-CN", {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                fractionalSecondDigits: 3
            })}`, true);
        }

        function stopAutoRefresh() {
            if (autoRefreshTimer) {
                clearTimeout(autoRefreshTimer);
                autoRefreshTimer = null;
            }
        }

        // 投注检查器
        function startBetChecker() {
            stopBetChecker();
            checkAndPlaceBets();
        }

        function stopBetChecker() {
            if (betCheckTimer) {
                clearTimeout(betCheckTimer);
                betCheckTimer = null;
            }
        }

        // 页面可见性处理
        function handleVisibilityChange() {
            const wasVisible = isPageVisible;
            isPageVisible = document.visibilityState === 'visible';
            
            if (isPageVisible && !wasVisible && isServiceRunning) {
                Logger.info("页面恢复可见，同步数据...", true);
                loadBetItems();
                startAutoRefresh();
                if (!betCheckTimer) {
                    startBetChecker();
                }
            }
        }

        // 刷新周期控制
        function resetRefreshCycle() {
            refreshCycleStartTime = Date.now();
            if (isServiceRunning && CONFIG.state.autoRefresh) {
                scheduleNextRefresh();
            }
        }

        // 参数转换工具
        function convertToMilliseconds(hours, minutes, seconds, milliseconds) {
            return (hours * 3600000) + (minutes * 60000) + (seconds * 1000) + milliseconds;
        }

        // 参数设置
        function setRefreshInterval() {
            const hours = parseInt(document.getElementById("refreshHoursInput").value) || 0;
            const minutes = parseInt(document.getElementById("refreshMinutesInput").value) || 0;
            const seconds = parseInt(document.getElementById("refreshSecondsInput").value) || 0;
            const milliseconds = parseInt(document.getElementById("refreshMillisecondsInput").value) || 0;
            
            const totalMs = convertToMilliseconds(hours, minutes, seconds, milliseconds);
            const totalSeconds = Math.floor(totalMs / 1000);
            CONFIG.state.refreshInterval = totalSeconds;
            CONFIG.state.refreshIntervalMs = totalMs % 1000;
            
            Logger.info(`已设置数据刷新间隔为 ${hours}小时${minutes}分${seconds}秒${milliseconds}毫秒`, true);
            
            if (isServiceRunning) {
                resetRefreshCycle();
                startAutoRefresh();
            }
        }

        function setFollowCheckInterval() {
            const seconds = parseInt(document.getElementById("followCheckSecInput").value) || 0;
            const milliseconds = parseInt(document.getElementById("followCheckIntervalInput").value) || 0;
            
            CONFIG.state.followCheckInterval = (seconds * 1000) + milliseconds;
            CONFIG.state.followCheckIntervalSec = seconds;
            
            Logger.info(`已设置跟随检查间隔为 ${seconds}秒${milliseconds}毫秒`, true);
            
            if (isServiceRunning && CONFIG.state.betStrategy === "follow") {
                CONFIG.state.availableBets.forEach(bet => {
                    startFollowingCheck(bet.id);
                });
            }
        }

        function saveParameters() {
            try {
                CONFIG.state.targetUserId = document.getElementById("targetUserIdInput").value || "205809";
                CONFIG.state.advanceSeconds = Math.max(0, parseInt(document.getElementById("advanceSecondsInput").value) || 3);
                CONFIG.state.toleranceSeconds = Math.max(0, parseInt(document.getElementById("toleranceSecondsInput").value) || 10);
                CONFIG.state.amountRange = Math.max(0, parseInt(document.getElementById("amountRangeInput").value) || 20000);
                CONFIG.state.baseAmount = Math.max(100, parseInt(document.getElementById("baseAmountInput").value) || 10000);
                CONFIG.state.betStrategy = document.getElementById("betStrategySelect").value || "higher_odds";
                CONFIG.state.checkInterval = Math.max(0.1, parseFloat(document.getElementById("checkIntervalInput").value) || 2);
                CONFIG.state.oddsThreshold = Math.max(1.0, parseFloat(document.getElementById("oddsThresholdInput").value) || 1.5);
                CONFIG.state.slippageTolerance = Math.max(0.01, parseFloat(document.getElementById("slippageToleranceInput").value) || 0.05);
                CONFIG.state.autoBetTriggerSec = Math.max(10, parseInt(document.getElementById("autoBetTriggerSecInput").value) || 30);
                CONFIG.state.aiRefreshInterval = Math.max(100, parseInt(document.getElementById("aiRefreshIntervalInput").value) || 1000);
                
                Logger.info(`参数已保存 - 提前下注: ${CONFIG.state.advanceSeconds}s, 容忍时间: ${CONFIG.state.toleranceSeconds}s`);
                
                if (isServiceRunning) {
                    processPendingBets(true);
                    renderBetTable();
                    renderPendingBetsTable();
                    
                    // 重启对应定时器
                    if (CONFIG.state.betStrategy === "follow") {
                        CONFIG.state.availableBets.forEach(bet => {
                            startFollowingCheck(bet.id);
                        });
                    } else {
                        CONFIG.state.availableBets.forEach(bet => {
                            startAIRefresh(bet.id);
                        });
                    }
                }
                
                return true;
            } catch (e) {
                Logger.error(`保存参数失败: ${e.message}`);
                return false;
            }
        }

        // 界面更新
        function updateServiceStatus() {
            const startBtn = document.getElementById("startServiceBtn");
            const stopBtn = document.getElementById("stopServiceBtn");
            const statusIndicator = document.getElementById("serviceStatusIndicator");
            const statusText = document.getElementById("serviceStatusText");
            
            startBtn.disabled = isServiceRunning;
            stopBtn.disabled = !isServiceRunning;
            
            if (statusIndicator) {
                statusIndicator.className = isServiceRunning 
                    ? "inline-block w-3 h-3 rounded-full bg-success mr-2" 
                    : "inline-block w-3 h-3 rounded-full bg-gray-400 mr-2";
            }
            
            if (statusText) {
                statusText.textContent = isServiceRunning ? "服务运行中" : "服务已停止";
            }
        }

        // 表格渲染
        function renderBetTable() {
            const table = document.getElementById("betItemsTable");
            if (!table) return;
            
            if (CONFIG.state.availableBets.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="6" class="border p-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i class="fa fa-inbox text-3xl mb-2 text-gray-300"></i>
                                <span>无可用投注项目</span>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = `
                <tr class="bg-gray-50">
                    <th class="border p-3 text-left font-semibold">ID</th>
                    <th class="border p-3 text-left font-semibold">描述</th>
                    <th class="border p-3 text-left font-semibold">选项 (赔率)</th>
                    <th class="border p-3 text-left font-semibold">最高赔率</th>
                    <th class="border p-3 text-left font-semibold">AI胜率/比分</th>
                    <th class="border p-3 text-left font-semibold">结束时间</th>
                </tr>
            `;
            
            CONFIG.state.availableBets.forEach(item => {
                const highestOption = getHighestOddsOption(item);
                
                let optionsHtml = "";
                if (item.optionsList && item.optionsList.length > 0) {
                    item.optionsList.forEach(opt => {
                        const isHighest = highestOption && opt.id === highestOption.id;
                        optionsHtml += `<div class="${isHighest ? 'font-bold text-success' : ''} py-1">
                            ${opt.text} (${opt.odds})
                        </div>`;
                    });
                } else {
                    optionsHtml = "无选项";
                }
                
                // AI测算显示（非跟随模式）
                const aiInfo = CONFIG.state.betStrategy !== "follow" 
                    ? `<div class="text-sm">
                        胜率: ${item.aiWinRate || "分析中"}%<br>
                        比分: ${item.aiScore || "分析中"}
                       </div>`
                    : "跟随模式无需AI测算";
                
                html += `<tr class="hover:bg-gray-50 transition-colors">
                    <td class="border p-3">${item.id}</td>
                    <td class="border p-3">${item.heading || '无描述'}</td>
                    <td class="border p-3">${optionsHtml}</td>
                    <td class="border p-3 text-success font-bold">${highestOption ? highestOption.odds : 'N/A'}</td>
                    <td class="border p-3 ${CONFIG.state.betStrategy === "follow" ? 'text-gray-500' : 'text-purple'}">${aiInfo}</td>
                    <td class="border p-3">${new Date(item.endtime).toLocaleString()}</td>
                </tr>`;
            });
            
            table.innerHTML = html;
        }

        function renderPendingBetsTable() {
            const table = document.getElementById("pendingBetsTable");
            if (!table) return;
            
            if (pendingBets.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="6" class="border p-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i class="fa fa-calendar-o text-3xl mb-2 text-gray-300"></i>
                                <span>暂无待投注项目</span>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = `
                <tr class="bg-gray-50">
                    <th class="border p-3 text-left font-semibold">ID</th>
                    <th class="border p-3 text-left font-semibold">描述</th>
                    <th class="border p-3 text-left font-semibold">投注对象</th>
                    <th class="border p-3 text-left font-semibold">下注时间</th>
                    <th class="border p-3 text-left font-semibold">金额</th>
                    <th class="border p-3 text-left font-semibold">状态</th>
                </tr>
            `;
            
            pendingBets.forEach(bet => {
                let statusClass = "text-primary";
                let statusBadge = "等待中";
                
                if (bet.status === "处理中") {
                    statusClass = "text-warning";
                    statusBadge = `<span class="flex items-center"><i class="fa fa-spinner fa-spin mr-1"></i> 处理中</span>`;
                }
                if (bet.status === "已完成") {
                    statusClass = "text-success";
                    statusBadge = `<span class="flex items-center"><i class="fa fa-check-circle mr-1"></i> 已完成</span>`;
                }
                if (bet.status === "失败") {
                    statusClass = "text-danger";
                    statusBadge = `<span class="flex items-center"><i class="fa fa-times-circle mr-1"></i> 失败</span>`;
                }
                
                // 跟随模式标记
                const strategyBadge = bet.strategy === "follow" 
                    ? `<span class="ml-2 text-xs bg-purple/10 text-purple px-1.5 rounded">跟随</span>` 
                    : "";
                
                html += `<tr class="hover:bg-gray-50 transition-colors">
                    <td class="border p-3">${bet.id}</td>
                    <td class="border p-3">${bet.heading || '无描述'}</td>
                    <td class="border p-3 font-bold text-success">${bet.highestOddsTeam} (${bet.highestOdds})${strategyBadge}</td>
                    <td class="border p-3">${bet.betTime.toLocaleString()}</td>
                    <td class="border p-3">${bet.betAmount}</td>
                    <td class="border p-3 ${statusClass}">${statusBadge}</td>
                </tr>`;
            });
            
            table.innerHTML = html;
        }

        // 页面初始化
        document.addEventListener("DOMContentLoaded", () => {
            // 初始化表单值
            document.getElementById("targetUserIdInput").value = CONFIG.state.targetUserId;
            document.getElementById("advanceSecondsInput").value = CONFIG.state.advanceSeconds;
            document.getElementById("toleranceSecondsInput").value = CONFIG.state.toleranceSeconds;
            document.getElementById("amountRangeInput").value = CONFIG.state.amountRange;
            document.getElementById("baseAmountInput").value = CONFIG.state.baseAmount;
            document.getElementById("betStrategySelect").value = CONFIG.state.betStrategy;
            document.getElementById("checkIntervalInput").value = CONFIG.state.checkInterval;
            document.getElementById("oddsThresholdInput").value = CONFIG.state.oddsThreshold;
            document.getElementById("slippageToleranceInput").value = CONFIG.state.slippageTolerance;
            document.getElementById("autoBetTriggerSecInput").value = CONFIG.state.autoBetTriggerSec;
            document.getElementById("aiRefreshIntervalInput").value = CONFIG.state.aiRefreshInterval;
            
            // 初始化刷新间隔（秒+毫秒）
            const totalMs = CONFIG.state.refreshInterval * 1000 + CONFIG.state.refreshIntervalMs;
            const hours = Math.floor(totalMs / 3600000);
            const minutes = Math.floor((totalMs % 3600000) / 60000);
            const seconds = Math.floor((totalMs % 60000) / 1000);
            const milliseconds = totalMs % 1000;
            document.getElementById("refreshHoursInput").value = hours;
            document.getElementById("refreshMinutesInput").value = minutes;
            document.getElementById("refreshSecondsInput").value = seconds;
            document.getElementById("refreshMillisecondsInput").value = milliseconds;
            
            // 初始化跟随检查间隔（秒+毫秒）
            const followTotalMs = CONFIG.state.followCheckInterval;
            const followSeconds = Math.floor(followTotalMs / 1000);
            const followMilliseconds = followTotalMs % 1000;
            document.getElementById("followCheckSecInput").value = followSeconds;
            document.getElementById("followCheckIntervalInput").value = followMilliseconds;
            
            // 绑定事件
            document.getElementById("startServiceBtn").addEventListener("click", startService);
            document.getElementById("stopServiceBtn").addEventListener("click", stopService);
            document.getElementById("verifyApiBtn").addEventListener("click", verifyApiKey);
            document.getElementById("saveParamsBtn").addEventListener("click", saveParameters);
            document.getElementById("setRefreshIntervalBtn").addEventListener("click", setRefreshInterval);
            document.getElementById("setFollowCheckIntervalBtn").addEventListener("click", setFollowCheckInterval);
            document.getElementById("manualRefreshBtn").addEventListener("click", loadBetItems);
            document.getElementById("clearLogBtn").addEventListener("click", () => Logger.clear());
            
            // 初始化界面
            renderBetTable();
            renderPendingBetsTable();
            updateServiceStatus();
            
            Logger.info("系统已启动，等待操作...");
        });
    </script>
</head>
<body class="bg-gray-50 p-4 md:p-6">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-primary mb-2">M-Team 投注系统</h1>
            <p class="text-gray-500">智能自动投注管理平台</p>
        </header>
        
        <!-- 服务控制区域 -->
        <div class="bg-white rounded-lg shadow card-shadow p-5 mb-6 hover-lift border-l-4 border-primary">
            <h2 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa fa-cogs text-primary mr-2"></i>服务控制
                <span class="ml-3 text-sm font-normal text-gray-500">
                    <span id="serviceStatusIndicator" class="inline-block w-3 h-3 rounded-full bg-gray-400 mr-2"></span>
                    <span id="serviceStatusText">服务未运行</span>
                </span>
            </h2>
            <div class="flex flex-wrap gap-3">
                <button id="startServiceBtn" class="bg-primary text-white px-5 py-2.5 rounded-lg flex items-center hover:bg-primary/90 transition-colors">
                    <i class="fa fa-play mr-2"></i>启动服务
                </button>
                <button id="stopServiceBtn" class="bg-danger text-white px-5 py-2.5 rounded-lg flex items-center opacity-50 cursor-not-allowed" disabled>
                    <i class="fa fa-stop mr-2"></i>停止服务
                </button>
                <button id="clearLogBtn" class="bg-warning text-white px-5 py-2.5 rounded-lg flex items-center hover:bg-warning/90 transition-colors">
                    <i class="fa fa-trash mr-2"></i>清理日志
                </button>
            </div>
        </div>
        
        <!-- API配置区域 -->
        <div class="bg-white rounded-lg shadow card-shadow p-5 mb-6 hover-lift border-l-4 border-success">
            <h2 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa fa-key text-success mr-2"></i>API 配置
            </h2>
            <div class="flex flex-wrap gap-3 items-center">
                <input type="text" id="apiKeyInput" placeholder="输入API Key" class="flex-1 min-w-[300px] p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-success focus:border-success outline-none transition-shadow">
                <button id="verifyApiBtn" class="bg-success text-white px-5 py-2.5 rounded-lg hover:bg-success/90 transition-colors">
                    验证API Key
                </button>
            </div>
        </div>
        
        <!-- 参数设置区域 -->
        <div class="bg-white rounded-lg shadow card-shadow p-5 mb-6 hover-lift border-l-4 border-warning">
            <h2 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa fa-sliders text-warning mr-2"></i>投注参数设置
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 mb-5">
                <div>
                    <label class="block text-sm text-gray-600 mb-1.5">目标用户ID（跟随策略）</label>
                    <input type="text" id="targetUserIdInput" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-warning focus:border-warning outline-none transition-shadow">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1.5">提前下注秒数</label>
                    <input type="number" id="advanceSecondsInput" min="0" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-warning focus:border-warning outline-none transition-shadow">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1.5">容忍秒数</label>
                    <input type="number" id="toleranceSecondsInput" min="0" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-warning focus:border-warning outline-none transition-shadow">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1.5">金额波动范围</label>
                    <input type="number" id="amountRangeInput" min="0" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-warning focus:border-warning outline-none transition-shadow">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1.5">基础金额</label>
                    <input type="number" id="baseAmountInput" min="1" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-warning focus:border-warning outline-none transition-shadow">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1.5">投注策略</label>
                    <select id="betStrategySelect" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-warning focus:border-warning outline-none transition-shadow">
                        <option value="larger">押大</option>
                        <option value="smaller">押小</option>
                        <option value="follow">跟随用户</option>
                        <option value="higher_odds">高赔率自动下注（AI测算）</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1.5">投注检查间隔(秒)</label>
                    <input type="number" id="checkIntervalInput" min="0.1" step="0.1" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-warning focus:border-warning outline-none transition-shadow">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1.5">跟随检查间隔</label>
                    <div class="flex gap-2">
                        <input type="number" id="followCheckSecInput" min="0" max="30" placeholder="秒" class="flex-1 p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-warning focus:border-warning outline-none transition-shadow">
                        <input type="number" id="followCheckIntervalInput" min="0" max="999" placeholder="毫秒" class="flex-1 p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-warning focus:border-warning outline-none transition-shadow">
                    </div>
                    <button id="setFollowCheckIntervalBtn" class="mt-2 text-sm text-primary hover:underline">设置间隔</button>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1.5">数据刷新间隔</label>
                    <div class="flex gap-2">
                        <input type="number" id="refreshHoursInput" min="0" max="24" placeholder="时" class="flex-1 p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-warning focus:border-warning outline-none transition-shadow">
                        <input type="number" id="refreshMinutesInput" min="0" max="59" placeholder="分" class="flex-1 p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-warning focus:border-warning outline-none transition-shadow">
                        <input type="number" id="refreshSecondsInput" min="0" max="59" placeholder="秒" class="flex-1 p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-warning focus:border-warning outline-none transition-shadow">
                        <input type="number" id="refreshMillisecondsInput" min="0" max="999" placeholder="毫秒" class="flex-1 p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-warning focus:border-warning outline-none transition-shadow">
                    </div>
                    <button id="setRefreshIntervalBtn" class="mt-2 text-sm text-primary hover:underline">设置间隔</button>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1.5">AI自动下注触发时间(秒)</label>
                    <input type="number" id="autoBetTriggerSecInput" min="10" max="60" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-warning focus:border-warning outline-none transition-shadow">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1.5">AI后台刷新间隔(毫秒)</label>
                    <input type="number" id="aiRefreshIntervalInput" min="100" max="5000" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-warning focus:border-warning outline-none transition-shadow">
                </div>
            </div>
            <div class="text-right">
                <button id="saveParamsBtn" class="bg-success text-white px-5 py-2.5 rounded-lg hover:bg-success/90 transition-colors">
                    保存参数
                </button>
            </div>
        </div>
        
        <!-- 可投注项目区域 -->
        <div class="bg-white rounded-lg shadow card-shadow p-5 mb-6 hover-lift border-l-4 border-primary">
            <h2 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa fa-list text-primary mr-2"></i>可投注项目
            </h2>
            <div class="flex flex-wrap gap-3 mb-5 items-center justify-between">
                <button id="manualRefreshBtn" class="bg-gray-600 text-white px-3.5 py-2.5 rounded-lg text-sm hover:bg-gray-700 transition-colors">
                    手动刷新
                </button>
            </div>
            <div class="overflow-x-auto">
                <table id="betItemsTable" class="min-w-full border-collapse">
                    <tr>
                        <td colspan="6" class="border p-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i class="fa fa-inbox text-3xl mb-2 text-gray-300"></i>
                                <span>请启动服务或手动刷新</span>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        
        <!-- 待投注项目区域 -->
        <div class="bg-white rounded-lg shadow card-shadow p-5 mb-6 hover-lift border-l-4 border-purple-500">
            <h2 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa fa-calendar text-purple-500 mr-2"></i>待投注项目
            </h2>
            <div class="overflow-x-auto">
                <table id="pendingBetsTable" class="min-w-full border-collapse">
                    <tr>
                        <td colspan="6" class="border p-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i class="fa fa-calendar-o text-3xl mb-2 text-gray-300"></i>
                                <span>暂无待投注项目</span>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        
        <!-- 日志区域 -->
        <div class="bg-white rounded-lg shadow card-shadow p-5 hover-lift border-l-4 border-gray-500">
            <h2 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa fa-history text-gray-500 mr-2"></i>操作日志
            </h2>
            <div id="logPanel" class="h-64 overflow-y-auto p-3 bg-gray-50 rounded-lg text-sm border border-gray-200">
                系统启动中...
            </div>
        </div>
    </div>
</body>
</html>
