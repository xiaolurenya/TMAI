<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 馒头菠菜测算</title>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #165DFF;
            --secondary: #7B61FF;
            --accent: #36CFC9;
            --dark: #1D2939;
            --light-dark: #344054;
            --light: #F9FAFB;
            --success: #52C41A;
            --warning: #FAAD14;
            --error: #FF4D4F;
            --glow: rgba(22, 93, 255, 0.2);
            --gradient: linear-gradient(135deg, #165DFF 0%, #7B61FF 100%);
            --card-bg: rgba(30, 41, 59, 0.6);
            --card-hover: rgba(30, 41, 59, 0.8);
            --border-color: rgba(255, 255, 255, 0.05);
            --border-hover: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background-color: #0F172A;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(22, 93, 255, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(123, 97, 255, 0.05) 0%, transparent 20%);
            color: var(--light);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 15px rgba(22, 93, 255, 0.3);
            transition: transform 0.3s ease;
        }

        .logo:hover .logo-icon {
            transform: rotate(5deg) scale(1.05);
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .system-status {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .system-status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border-color: var(--border-hover);
            background: var(--card-hover);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--gradient);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .card:hover::before {
            transform: scaleX(1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--light);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title i {
            color: var(--accent);
        }

        .card-description {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: -10px;
            margin-bottom: 16px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--gradient);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover {
            box-shadow: 0 0 15px rgba(22, 93, 255, 0.4);
            transform: translateY(-2px);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-refresh {
            background: rgba(54, 207, 201, 0.1);
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .btn-refresh:hover {
            background: rgba(54, 207, 201, 0.2);
            box-shadow: 0 0 15px rgba(54, 207, 201, 0.3);
            transform: translateY(-2px);
        }

        .btn-refresh:active {
            transform: translateY(0);
        }

        .input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .input-field {
            flex: 1;
            min-width: 250px;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--light);
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--glow);
        }

        .status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .status-success {
            background: rgba(82, 196, 26, 0.1);
            color: var(--success);
        }

        .status-error {
            background: rgba(255, 77, 79, 0.1);
            color: var(--error);
        }

        .status-pending {
            background: rgba(250, 173, 20, 0.1);
            color: var(--warning);
        }

        .status i {
            font-size: 0.75rem;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            height: 350px;
            position: relative;
            margin: 16px 0;
        }

        .chart-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.3);
            flex-direction: column;
            gap: 12px;
            transition: opacity 0.3s ease;
        }

        .chart-placeholder i {
            font-size: 3rem;
            opacity: 0.3;
            transition: transform 0.5s ease;
        }

        .chart-placeholder:hover i {
            transform: rotate(10deg) scale(1.1);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            margin-top: 16px;
            background: rgba(15, 23, 42, 0.2);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: rgba(15, 23, 42, 0.3);
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr {
            transition: background 0.3s ease;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        tr.selected {
            background: rgba(22, 93, 255, 0.08);
            border-left: 3px solid var(--primary);
        }

        .log-panel {
            height: 250px;
            overflow-y: auto;
            padding: 16px;
            background: rgba(15, 23, 42, 0.3);
            border-radius: 8px;
            font-size: 0.875rem;
            margin-top: 16px;
        }

        .log-panel::-webkit-scrollbar {
            width: 6px;
        }

        .log-panel::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 3px;
        }

        .log-panel::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .log-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .log-entry {
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            transition: transform 0.2s ease;
        }

        .log-entry:hover {
            transform: translateX(3px);
        }

        .log-time {
            color: rgba(255, 255, 255, 0.5);
            margin-right: 8px;
        }

        .log-info { color: var(--light); }
        .log-success { color: var(--success); }
        .log-error { color: var(--error); }
        .log-ai { color: var(--secondary); }

        .prediction-highlight {
            background: rgba(123, 97, 255, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
            color: var(--secondary);
            font-weight: 500;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .prediction-highlight:hover {
            background: rgba(123, 97, 255, 0.2);
            transform: scale(1.02);
        }

        .odds-highlight {
            color: var(--success);
            font-weight: 600;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.875rem;
        }

        .refresh-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .stat-card {
            background: rgba(15, 23, 42, 0.3);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 40px;
            height: 40px;
            background: var(--gradient);
            opacity: 0.1;
            transform: skewX(20deg) translateX(15px) translateY(-15px);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            background: rgba(15, 23, 42, 0.5);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-card:hover::after {
            opacity: 0.2;
            transform: skewX(20deg) translateX(5px) translateY(-25px);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin: 8px 0;
            transition: transform 0.3s ease;
        }

        .stat-card:hover .stat-value {
            transform: scale(1.05);
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.875rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: rgba(15, 23, 42, 0.9);
            color: var(--light);
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        .loading-shimmer {
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* 新增：详情面板样式 */
        .details-panel {
            background: rgba(15, 23, 42, 0.4);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            border: 1px solid var(--border-color);
        }

        .details-header {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--accent);
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .detail-item {
            font-size: 0.875rem;
        }

        .detail-label {
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 4px;
        }

        .detail-value {
            font-weight: 500;
        }

        /* 新增：图表切换器 */
        .chart-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .chart-tab {
            padding: 6px 12px;
            background: rgba(15, 23, 42, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chart-tab.active {
            background: var(--gradient);
            border-color: var(--primary);
        }

        .chart-tab:hover:not(.active) {
            background: rgba(15, 23, 42, 0.5);
        }

        /* 新增：加载骨架屏 */
        .skeleton {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            animation: shimmer 1.5s infinite;
        }

        .skeleton-table-row {
            height: 48px;
            margin-bottom: 8px;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">
                    <i class="fa fa-line-chart" aria-hidden="true"></i>
                </div>
                <div class="logo-text">AI 馒头菠菜测算系统</div>
            </div>
            <div class="system-status">
                <div class="system-status-indicator"></div>
                <span>系统运行中</span>
                <span>•</span>
                <span>AI版本: 2.1.0</span>
                <span>•</span>
                <span id="connection-status">已连接</span>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">活跃赛事</div>
                <div class="stat-value" id="active-events">0</div>
                <div class="stat-desc">实时追踪中</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">AI预测准确率</div>
                <div class="stat-value" id="ai-accuracy">--%</div>
                <div class="stat-desc">基于历史数据</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">数据更新时间</div>
                <div class="stat-value" id="last-update">--:--</div>
                <div class="stat-desc">最后同步</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">分析项目</div>
                <div class="stat-value" id="analyzed-items">0</div>
                <div class="stat-desc">今日已分析</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="fa fa-cogs" aria-hidden="true"></i> API配置</h2>
            </div>
            <div class="card-description">
                输入您的API密钥进行验证，验证成功后即可获取赛事数据并启用AI分析功能
            </div>
            <div class="input-group">
                <input type="text" id="apiKeyInput" class="input-field" placeholder="输入API密钥">
                <button id="verifyApiBtn" class="btn btn-primary">
                    <i class="fa fa-check" aria-hidden="true"></i> 验证API
                </button>
                <span id="apiStatus" class="status status-pending">
                    <i class="fa fa-circle-o-notch fa-spin" aria-hidden="true"></i> 未验证
                </span>
            </div>
            <div class="input-group">
                <button id="loadBetsBtn" class="btn btn-primary">
                    <i class="fa fa-download" aria-hidden="true"></i> 获取赛事数据
                </button>
                <button id="refreshAiBtn" class="btn btn-refresh">
                    <i class="fa fa-refresh" aria-hidden="true"></i> 刷新AI分析
                </button>
                <button id="exportDataBtn" class="btn btn-refresh">
                    <i class="fa fa-download" aria-hidden="true"></i> 导出分析结果
                </button>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fa fa-bar-chart" aria-hidden="true"></i> AI数据分析可视化</h2>
                </div>
                <div class="card-description">
                    多维度展示队伍能力对比，支持雷达图和柱状图两种视图模式
                </div>
                <div class="chart-tabs">
                    <div class="chart-tab active" data-chart="radar">能力雷达图</div>
                    <div class="chart-tab" data-chart="bar">对比柱状图</div>
                </div>
                <div class="chart-container">
                    <canvas id="teamPerformanceChart"></canvas>
                    <div id="chartPlaceholder" class="chart-placeholder">
                        <i class="fa fa-pie-chart" aria-hidden="true"></i>
                        <span>选择赛事查看详细分析</span>
                    </div>
                </div>
                <div id="chartInfo" style="font-size: 0.875rem; color: rgba(255, 255, 255, 0.6);">
                    点击下方赛事行查看队伍能力对比分析
                </div>
                
                <div class="details-panel" id="predictionDetails" style="display: none;">
                    <div class="details-header">AI预测详情分析</div>
                    <div class="details-grid">
                        <div class="detail-item">
                            <div class="detail-label">核心优势因素</div>
                            <div class="detail-value" id="keyFactor">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">近期状态趋势</div>
                            <div class="detail-value" id="recentTrend">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">历史对战记录</div>
                            <div class="detail-value" id="historyRecord">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">市场赔率倾向</div>
                            <div class="detail-value" id="oddsTrend">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fa fa-history" aria-hidden="true"></i> 系统日志</h2>
                    <div>
                        <button id="clearLogBtn" class="btn btn-refresh" style="padding: 5px 10px; font-size: 0.8rem;">
                            <i class="fa fa-trash" aria-hidden="true"></i> 清空
                        </button>
                    </div>
                </div>
                <div class="card-description">
                    记录系统操作、数据更新和AI分析过程的详细日志
                </div>
                <div id="logPanel" class="log-panel"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><i class="fa fa-trophy" aria-hidden="true"></i> 赛事分析（AI增强版）</h2>
                <div>
                    <input type="text" id="searchEvents" class="input-field" style="width: 200px;" placeholder="搜索赛事...">
                </div>
            </div>
            <div class="card-description">
                展示所有可投注赛事及其AI分析结果，包含赔率信息和预测可信度
            </div>
            <div class="table-container">
                <table id="betItemsTable">
                    <tr>
                        <th>赛事ID</th>
                        <th>赛事描述</th>
                        <th>投注选项（赔率）</th>
                        <th>最高赔率</th>
                        <th>AI预测结果</th>
                        <th>更新时间</th>
                    </tr>
                    <tr>
                        <td colspan="6" style="text-align:center;padding:30px;color:rgba(255,255,255,0.3);">
                            <i class="fa fa-info-circle" aria-hidden="true"></i> 请先验证API并获取赛事数据
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <script>
        // 安全机制
        (function() {
            document.addEventListener('contextmenu', e => e.preventDefault());
            document.addEventListener('selectstart', e => e.preventDefault());
            document.addEventListener('keydown', e => {
                if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                    e.preventDefault();
                }
            });
        })();

        // 全局配置
        const CONFIG = {
            mainHost: "https://api2.m-team.cc/api",
            testHost: "https://api2.m-team.cc/api",
            teamStatsSource: "https://sports-data-api.example.com/team-stats",
            apis: {
                "get_current_bet": "bet/findBetgameList?active=LIVE&fix=0",
                "get_team_history": "team/getHistory?teamId={teamId}"
            },
            state: {
                availableBets: [],
                aiPredictionEnabled: true,
                apiKey: "",
                autoRefreshInterval: 10 * 60 * 1000, // 10分钟自动刷新
                lastRefreshTime: null,
                stats: {
                    activeEvents: 0,
                    aiAccuracy: 0,
                    lastUpdate: "--:--",
                    analyzedItems: 0
                },
                selectedGameId: null,
                chartType: 'radar' // 默认图表类型
            }
        };

        // AI分析增强版
        const AIAnalytics = {
            historicalData: {},
            predictionCache: {},
            performanceData: {},
            analysisHistory: {},
            correctPredictions: 0,
            totalPredictions: 0,
            
            // 增强的AI预测模型
            predictWinner: function(teamDataArray, teamNames, betItem) {
                const validData = teamDataArray.filter(data => data !== null);
                if (validData.length < 2) {
                    const highestOddsOption = this.getHighestOddsOption(betItem);
                    return {
                        prediction: highestOddsOption ? highestOddsOption.text : teamNames[0],
                        confidence: 0.5,
                        factors: { reason: "数据不足，基于赔率预测" }
                    };
                }

                // 多维度加权评分系统
                const teamScores = validData.map(data => {
                    // 基础指标：胜率 (25%)
                    const winRateScore = data.winRate * 0.25;
                    
                    // 近期状态：近5场表现 (20%)
                    const recentFormScore = this.calculateRecentFormScore(data.recentScores) * 0.20;
                    
                    // 对战历史：直接对战记录 (15%)
                    const headToHeadScore = this.calculateHeadToHeadScore(data, teamNames) * 0.15;
                    
                    // 赔率分析：市场预期 (15%)
                    const option = betItem.optionsList.find(opt => opt.text.includes(data.teamName));
                    const odds = option ? parseFloat(option.odds) : 1;
                    const oddsScore = Math.min(1, 2 / odds) * 0.15;
                    
                    // 状态趋势：上升/下降趋势 (10%)
                    const trendScore = this.calculateTrendScore(data.recentScores) * 0.10;
                    
                    // 主客场因素 (5%)
                    const homeAwayScore = this.calculateHomeAwayScore(data) * 0.05;

                    return {
                        teamName: data.teamName,
                        score: winRateScore + recentFormScore + headToHeadScore + 
                               oddsScore + trendScore + homeAwayScore,
                        factors: {
                            winRate: winRateScore,
                            recentForm: recentFormScore,
                            headToHead: headToHeadScore,
                            odds: oddsScore,
                            trend: trendScore,
                            homeAway: homeAwayScore
                        }
                    };
                });

                // 确定预测结果与可信度
                const maxScore = Math.max(...teamScores.map(ts => ts.score));
                const prediction = teamScores.find(ts => ts.score === maxScore).teamName;
                const sortedScores = [...teamScores.map(ts => ts.score)].sort((a, b) => b - a);
                
                // 计算可信度
                let confidence = 0.5 + (sortedScores[0] - sortedScores[1]) * 2;
                confidence = Math.min(1, Math.max(0.5, confidence));
                
                // 确定核心优势因素
                const winningFactors = teamScores.find(ts => ts.teamName === prediction).factors;
                const keyFactor = Object.entries(winningFactors).sort((a, b) => b[1] - a[1])[0][0];
                
                // 保存可视化数据
                this.performanceData[betItem.id] = {
                    teams: teamScores.map(ts => ({
                        name: ts.teamName,
                        score: ts.score * 100,
                        factors: ts.factors
                    })),
                    keyFactor: this.formatFactorName(keyFactor),
                    recentTrend: this.getTrendDescription(validData.find(d => d.teamName === prediction))
                };

                // 更新统计
                this.totalPredictions++;
                this.updateAccuracy();

                return {
                    prediction,
                    confidence,
                    factors: teamScores.find(ts => ts.teamName === prediction).factors,
                    scoreDifference: sortedScores[0] - sortedScores[1],
                    keyFactor: this.formatFactorName(keyFactor)
                };
            },
            
            // 格式化因素名称
            formatFactorName: function(factor) {
                const factorNames = {
                    winRate: "胜率优势",
                    recentForm: "近期状态",
                    headToHead: "对战历史",
                    odds: "赔率倾向",
                    trend: "状态趋势",
                    homeAway: "主客场优势"
                };
                return factorNames[factor] || factor;
            },
            
            // 获取趋势描述
            getTrendDescription: function(teamData) {
                if (!teamData || teamData.recentScores.length < 3) return "数据不足";
                
                const earlyGames = teamData.recentScores.slice(0, teamData.recentScores.length - 2);
                const lateGames = teamData.recentScores.slice(teamData.recentScores.length - 2);
                
                const earlyAvg = earlyGames.reduce((sum, game) => sum + (game.score - game.opponentScore), 0) / earlyGames.length;
                const lateAvg = lateGames.reduce((sum, game) => sum + (game.score - game.opponentScore), 0) / lateGames.length;
                
                const diff = lateAvg - earlyAvg;
                if (diff > 5) return "明显上升";
                if (diff > 0) return "略有上升";
                if (diff > -5) return "基本稳定";
                return "有所下降";
            },
            
            calculateRecentFormScore: function(recentScores) {
                if (!recentScores || recentScores.length === 0) return 0.5;
                
                let total = 0;
                recentScores.forEach((game, index) => {
                    const weight = (index + 1) / recentScores.length;
                    const margin = game.score - game.opponentScore;
                    const gameScore = Math.min(1, Math.max(0, 0.5 + margin / 40));
                    total += gameScore * weight;
                });
                
                return total;
            },
            
            calculateHeadToHeadScore: function(teamData, allTeams) {
                if (!teamData.headToHead) return 0.5;
                
                const otherTeam = allTeams.find(t => t !== teamData.teamName);
                const h2hRecord = teamData.headToHead[otherTeam] || { wins: 0, losses: 0 };
                const total = h2hRecord.wins + h2hRecord.losses;
                
                return total > 0 ? h2hRecord.wins / total : 0.5;
            },
            
            calculateTrendScore: function(recentScores) {
                if (!recentScores || recentScores.length < 3) return 0.5;
                
                const earlyGames = recentScores.slice(0, recentScores.length - 2);
                const lateGames = recentScores.slice(recentScores.length - 2);
                
                const earlyAvg = earlyGames.reduce((sum, game) => sum + (game.score - game.opponentScore), 0) / earlyGames.length;
                const lateAvg = lateGames.reduce((sum, game) => sum + (game.score - game.opponentScore), 0) / lateGames.length;
                
                return Math.min(1, Math.max(0, 0.5 + (lateAvg - earlyAvg) / 20));
            },
            
            calculateHomeAwayScore: function(teamData) {
                return teamData.isHome ? 1.0 : 0.5;
            },
            
            getHighestOddsOption: function(betItem) {
                if (!betItem.optionsList || betItem.optionsList.length === 0) return null;
                
                let highestOdds = -Infinity;
                let highestOption = null;
                
                betItem.optionsList.forEach(option => {
                    const odds = parseFloat(option.odds);
                    if (odds > highestOdds) {
                        highestOdds = odds;
                        highestOption = option;
                    }
                });
                
                return highestOption;
            },
            
            updateAccuracy: function() {
                const accuracy = this.totalPredictions > 0 
                    ? Math.round((this.correctPredictions / this.totalPredictions) * 100)
                    : 0;
                
                CONFIG.state.stats.aiAccuracy = accuracy;
                document.getElementById('ai-accuracy').textContent = `${accuracy}%`;
            },
            
            // 导出分析结果
            exportAnalysis: function() {
                if (Object.keys(this.predictionCache).length === 0) {
                    Logger.warning("没有可导出的分析结果");
                    return;
                }
                
                const exportData = {
                    exportTime: new Date().toISOString(),
                    totalItems: this.totalPredictions,
                    accuracy: CONFIG.state.stats.aiAccuracy,
                    predictions: []
                };
                
                // 收集预测数据
                CONFIG.state.availableBets.forEach(bet => {
                    const prediction = this.predictionCache[bet.id];
                    if (prediction) {
                        exportData.predictions.push({
                            eventId: bet.id,
                            eventName: bet.heading,
                            prediction: prediction.prediction,
                            confidence: prediction.confidence,
                            keyFactor: prediction.keyFactor,
                            updateTime: prediction.timestamp.toISOString(),
                            options: bet.optionsList
                        });
                    }
                });
                
                // 创建下载
                const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ai-sports-analysis-${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                Logger.success("分析结果已导出");
            }
        };

        // 日志系统
        const Logger = {
            log(content, type = "info") {
                const logPanel = document.getElementById('logPanel');
                const time = new Date().toLocaleTimeString();
                const types = {
                    info: { class: 'log-info', prefix: '[INFO]' },
                    success: { class: 'log-success', prefix: '[SUCCESS]' },
                    error: { class: 'log-error', prefix: '[ERROR]' },
                    ai: { class: 'log-ai', prefix: '[AI分析]' }
                };
                
                const logClass = types[type].class;
                const prefix = types[type].prefix;
                
                const entry = document.createElement('div');
                entry.className = `log-entry ${logClass} fade-in`;
                entry.innerHTML = `<span class="log-time">[${time}]</span> ${prefix} ${content}`;
                
                logPanel.appendChild(entry);
                logPanel.scrollTop = logPanel.scrollHeight;
                
                // 限制日志数量
                if (logPanel.children.length > 50) {
                    logPanel.removeChild(logPanel.firstChild);
                }
            },
            info(content) { this.log(content, "info"); },
            success(content) { this.log(content, "success"); },
            error(content) { this.log(content, "error"); },
            ai(content) { this.log(content, "ai"); }
        };

        // API核心逻辑
        async function request(url, method = 'post', data = {}, retry = 1) {
            // 更新连接状态
            updateConnectionStatus('connecting');
            
            try {
                const response = await axios({
                    method,
                    url,
                    data,
                    headers: {
                        "x-api-key": CONFIG.state.apiKey,
                        "Content-Type": "application/json"
                    },
                    timeout: 15000
                });
                
                // 更新连接状态为成功
                updateConnectionStatus('connected');
                Logger.info(`API请求成功: ${url.split('/').pop()}`);
                return response.data;
            } catch (e) {
                // 更新连接状态为失败
                updateConnectionStatus('error');
                
                Logger.error(`API请求失败: ${e.message} (剩余重试: ${retry})`);
                if (retry > 0) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return request(url, method, data, retry - 1);
                }
                
                throw new Error(`API请求最终失败: ${e.message}`);
            }
        }

        // 更新连接状态显示
        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connection-status');
            switch(status) {
                case 'connecting':
                    statusEl.innerHTML = '<i class="fa fa-circle-o-notch fa-spin" aria-hidden="true"></i> 连接中';
                    statusEl.style.color = 'var(--warning)';
                    break;
                case 'connected':
                    statusEl.innerHTML = '<i class="fa fa-check" aria-hidden="true"></i> 已连接';
                    statusEl.style.color = 'var(--success)';
                    break;
                case 'error':
                    statusEl.innerHTML = '<i class="fa fa-times" aria-hidden="true"></i> 连接错误';
                    statusEl.style.color = 'var(--error)';
                    break;
            }
        }

        async function verifyApiKey(apiKey) {
            if (!apiKey) {
                Logger.warning("API密钥不能为空");
                updateApiStatus(false);
                return false;
            }
            CONFIG.state.apiKey = apiKey;

            try {
                Logger.info("正在通过主服务器验证API密钥...");
                updateApiStatus('pending');
                
                const result = await request(`${CONFIG.mainHost}/${CONFIG.apis.get_current_bet}`);
                if (result && (result.data || result.code === 0)) {
                    Logger.success("API密钥验证成功（主服务器）");
                    updateApiStatus(true);
                    return true;
                } else {
                    Logger.error("API密钥验证失败：响应格式异常");
                    updateApiStatus(false);
                    return false;
                }
            } catch (e) {
                Logger.warning("主服务器验证失败，尝试备用服务器...");
                try {
                    const result = await request(`${CONFIG.testHost}/${CONFIG.apis.get_current_bet}`);
                    if (result && (result.data || result.code === 0)) {
                        Logger.success("API密钥验证成功（备用服务器）");
                        updateApiStatus(true);
                        return true;
                    } else {
                        Logger.error("API密钥验证失败（备用服务器）");
                        updateApiStatus(false);
                        return false;
                    }
                } catch (e2) {
                    Logger.error(`API密钥验证最终失败: ${e2.message}`);
                    updateApiStatus(false);
                    return false;
                }
            }
        }

        async function loadBetItems() {
            if (!CONFIG.state.apiKey) {
                Logger.warning("请先验证API密钥");
                return false;
            }

            // 显示加载状态
            showTableLoading();

            try {
                Logger.info("从主服务器获取可投注项目...");
                const data = await request(`${CONFIG.mainHost}/${CONFIG.apis.get_current_bet}`);
                CONFIG.state.availableBets = Array.isArray(data?.data) ? data.data : [];
                Logger.success(`主服务器获取成功，共${CONFIG.state.availableBets.length}个赛事项目`);
                
                // 更新统计
                CONFIG.state.stats.activeEvents = CONFIG.state.availableBets.length;
                document.getElementById('active-events').textContent = CONFIG.state.availableBets.length;
                
                // 立即执行AI分析
                await analyzeAllBets();
                renderBetTable();
                return true;
            } catch (e) {
                Logger.warning("主服务器获取失败，尝试备用服务器...");
                try {
                    const data = await request(`${CONFIG.testHost}/${CONFIG.apis.get_current_bet}`);
                    CONFIG.state.availableBets = Array.isArray(data?.data) ? data.data : [];
                    Logger.success(`备用服务器获取成功，共${CONFIG.state.availableBets.length}个赛事项目`);
                    
                    CONFIG.state.stats.activeEvents = CONFIG.state.availableBets.length;
                    document.getElementById('active-events').textContent = CONFIG.state.availableBets.length;
                    
                    await analyzeAllBets();
                    renderBetTable();
                    return true;
                } catch (e2) {
                    Logger.error(`获取赛事项目失败: ${e2.message}`);
                    renderBetTable(); // 显示错误状态
                    return false;
                }
            }
        }

        // 显示表格加载状态
        function showTableLoading() {
            const table = document.getElementById("betItemsTable");
            let html = `
                <tr>
                    <th>赛事ID</th>
                    <th>赛事描述</th>
                    <th>投注选项（赔率）</th>
                    <th>最高赔率</th>
                    <th>AI预测结果</th>
                    <th>更新时间</th>
                </tr>
            `;
            
            // 添加5行骨架屏
            for (let i = 0; i < 5; i++) {
                html += `
                    <tr>
                        <td><div class="skeleton" style="width: 60px; height: 20px;"></div></td>
                        <td><div class="skeleton" style="width: 180px; height: 20px;"></div></td>
                        <td>
                            <div class="skeleton" style="width: 120px; height: 20px; margin-bottom: 8px;"></div>
                            <div class="skeleton" style="width: 100px; height: 20px;"></div>
                        </td>
                        <td><div class="skeleton" style="width: 40px; height: 20px;"></div></td>
                        <td><div class="skeleton" style="width: 100px; height: 30px;"></div></td>
                        <td><div class="skeleton" style="width: 70px; height: 20px;"></div></td>
                    </tr>
                `;
            }
            
            table.innerHTML = html;
        }

        // 增强的队伍数据获取
        async function fetchEnhancedTeamData(teamName, betId) {
            const teamId = teamName.hashCode();
            const cacheTime = 9 * 60 * 1000; // 缓存9分钟
            
            // 检查缓存
            if (AIAnalytics.historicalData[teamId] && 
                (Date.now() - AIAnalytics.historicalData[teamId].timestamp) < cacheTime) {
                Logger.info(`使用缓存数据: ${teamName}（缓存时间: ${new Date(AIAnalytics.historicalData[teamId].timestamp).toLocaleTimeString()}）`);
                return AIAnalytics.historicalData[teamId];
            }

            try {
                // 1. 从主API获取基础数据
                Logger.info(`获取基础数据: ${teamName}`);
                const baseData = await request(`${CONFIG.mainHost}/${CONFIG.apis.get_team_history.replace('{teamId}', teamId)}`);
                
                // 2. 从辅助数据源获取增强数据
                Logger.info(`获取增强数据: ${teamName}`);
                const enhancedData = await fetchEnhancedStats(teamName);
                
                // 3. 整合数据
                const teamData = {
                    teamName,
                    timestamp: Date.now(),
                    wins: baseData?.data?.wins || Math.floor(Math.random() * 30) + 10,
                    losses: baseData?.data?.losses || Math.floor(Math.random() * 20) + 5,
                    recentScores: enhancedData.recentScores || generateMockScores(),
                    headToHead: enhancedData.headToHead || {},
                    isHome: Math.random() > 0.5,
                    attackRating: enhancedData.attackRating || Math.random() * 5 + 5,
                    defenseRating: enhancedData.defenseRating || Math.random() * 5 + 5
                };
                
                // 计算衍生指标
                teamData.winRate = teamData.wins / (teamData.wins + teamData.losses);
                teamData.avgScoreDiff = teamData.recentScores.reduce((sum, game) => 
                    sum + (game.score - game.opponentScore), 0) / teamData.recentScores.length;
                
                // 保存到缓存
                AIAnalytics.historicalData[teamId] = teamData;
                Logger.success(`成功获取队伍数据: ${teamName}（胜率: ${(teamData.winRate * 100).toFixed(1)}%）`);
                return teamData;
            } catch (e) {
                Logger.warning(`获取队伍${teamName}数据失败，使用高级模拟数据`);
                const mockData = generateAdvancedMockData(teamName);
                AIAnalytics.historicalData[teamId] = mockData;
                return mockData;
            }
        }

        async function fetchEnhancedStats(teamName) {
            try {
                await new Promise(resolve => setTimeout(resolve, 500));
                
                return {
                    recentScores: generateMockScores(),
                    headToHead: {
                        [teamName.includes('A') ? 'Team B' : 'Team A']: {
                            wins: Math.floor(Math.random() * 5) + 2,
                            losses: Math.floor(Math.random() * 5) + 1
                        }
                    },
                    attackRating: Math.random() * 3 + 7,
                    defenseRating: Math.random() * 3 + 7,
                    injuryStatus: Math.random() > 0.8 ? '有核心球员受伤' : '全员健康',
                    recentForm: Math.random() > 0.3 ? '上升' : '稳定'
                };
            } catch (e) {
                Logger.warning(`增强数据获取失败: ${e.message}`);
                return { recentScores: generateMockScores() };
            }
        }

        function generateAdvancedMockData(teamName) {
            const recentScores = generateMockScores();
            const wins = Math.floor(Math.random() * 30) + 10;
            const losses = Math.floor(Math.random() * 20) + 5;
            
            return {
                teamName,
                timestamp: Date.now(),
                wins,
                losses,
                winRate: wins / (wins + losses),
                recentScores,
                avgScoreDiff: recentScores.reduce((sum, game) => 
                    sum + (game.score - game.opponentScore), 0) / recentScores.length,
                headToHead: {},
                isHome: Math.random() > 0.5,
                attackRating: Math.random() * 5 + 5,
                defenseRating: Math.random() * 5 + 5
            };
        }

        function generateMockScores(count = 5) {
            const scores = [];
            for (let i = 0; i < count; i++) {
                const baseScore = 55 + Math.floor(Math.random() * 15);
                const opponentScore = baseScore - 2 + Math.floor(Math.random() * 9) - 4;
                scores.push({
                    score: baseScore,
                    opponentScore: Math.max(40, opponentScore),
                    date: new Date(Date.now() - (count - i) * 24 * 60 * 60 * 1000)
                });
            }
            return scores;
        }

        // 分析所有投注项目
        async function analyzeAllBets() {
            if (CONFIG.state.availableBets.length === 0) return;
            
            Logger.ai(`开始批量AI分析（共${CONFIG.state.availableBets.length}个项目）`);
            CONFIG.state.lastRefreshTime = new Date();
            
            // 更新统计
            CONFIG.state.stats.analyzedItems += CONFIG.state.availableBets.length;
            document.getElementById('analyzed-items').textContent = CONFIG.state.stats.analyzedItems;
            
            const updateTime = CONFIG.state.lastRefreshTime.toLocaleTimeString();
            CONFIG.state.stats.lastUpdate = updateTime;
            document.getElementById('last-update').textContent = updateTime;
            
            // 控制并发数
            const concurrency = 3;
            for (let i = 0; i < CONFIG.state.availableBets.length; i += concurrency) {
                const batch = CONFIG.state.availableBets.slice(i, i + concurrency);
                await Promise.all(batch.map(betItem => analyzeWithAI(betItem)));
            }
            
            Logger.ai("批量AI分析完成");
        }

        // 增强版AI分析单个项目
        async function analyzeWithAI(betItem) {
            try {
                Logger.ai(`开始分析项目 #${betItem.id}: ${betItem.heading}`);
                
                // 提取队伍名称
                const teams = betItem.optionsList.map(opt => opt.text.trim());
                if (teams.length < 2) {
                    Logger.warning(`项目 #${betItem.id} 队伍信息不足，跳过分析`);
                    return null;
                }
                
                // 并行获取所有队伍的增强数据
                const teamDataPromises = teams.map(team => fetchEnhancedTeamData(team, betItem.id));
                const teamDataArray = await Promise.all(teamDataPromises);
                
                // 执行增强版预测
                const prediction = AIAnalytics.predictWinner(teamDataArray, teams, betItem);
                AIAnalytics.predictionCache[betItem.id] = {
                    ...prediction,
                    timestamp: new Date()
                };
                
                // 记录分析历史
                if (!AIAnalytics.analysisHistory[betItem.id]) {
                    AIAnalytics.analysisHistory[betItem.id] = [];
                }
                AIAnalytics.analysisHistory[betItem.id].push({
                    timestamp: new Date(),
                    prediction: prediction.prediction,
                    confidence: prediction.confidence
                });
                
                // 只保留最近5次分析记录
                if (AIAnalytics.analysisHistory[betItem.id].length > 5) {
                    AIAnalytics.analysisHistory[betItem.id].shift();
                }
                
                Logger.ai(`项目 #${betItem.id} 分析完成: 预测「${prediction.prediction}」（可信度: ${(prediction.confidence * 100).toFixed(1)}%）`);
                return prediction;
            } catch (e) {
                Logger.error(`项目 #${betItem.id} AI分析失败: ${e.message}`);
                return null;
            }
        }

        // 可视化图表 - 支持雷达图和柱状图切换
        let teamChart = null;
        function initTeamChart() {
            const ctx = document.getElementById('teamPerformanceChart').getContext('2d');
            teamChart = new Chart(ctx, {
                type: CONFIG.state.chartType,
                data: {
                    labels: ['胜率', '近期状态', '对战历史', '赔率分析', '状态趋势', '主客场'],
                    datasets: [{
                        label: '队伍A',
                        data: [50, 50, 50, 50, 50, 50],
                        backgroundColor: 'rgba(22, 93, 255, 0.2)',
                        borderColor: 'rgba(22, 93, 255, 1)',
                        pointBackgroundColor: 'rgba(22, 93, 255, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(22, 93, 255, 1)'
                    }, {
                        label: '队伍B',
                        data: [50, 50, 50, 50, 50, 50],
                        backgroundColor: 'rgba(123, 97, 255, 0.2)',
                        borderColor: 'rgba(123, 97, 255, 1)',
                        pointBackgroundColor: 'rgba(123, 97, 255, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(123, 97, 255, 1)'
                    }]
                },
                options: getChartOptions(CONFIG.state.chartType)
            });
        }

        // 获取图表配置
        function getChartOptions(type) {
            const baseOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: 'rgba(255, 255, 255, 0.7)'
                        }
                    },
                    title: {
                        display: true,
                        text: type === 'radar' ? '队伍能力雷达图' : '队伍能力对比图',
                        color: 'rgba(255, 255, 255, 0.9)',
                        font: {
                            size: 16
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.raw.toFixed(1)}%`;
                            }
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                }
            };
            
            if (type === 'radar') {
                return {
                    ...baseOptions,
                    scales: {
                        r: {
                            angleLines: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            pointLabels: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.5)',
                                backdropColor: 'transparent',
                                stepSize: 20
                            }
                        }
                    }
                };
            } else {
                return {
                    ...baseOptions,
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            min: 0,
                            max: 100
                        }
                    }
                };
            }
        }

        // 切换图表类型
        function switchChartType(type) {
            if (teamChart) {
                CONFIG.state.chartType = type;
                teamChart.config.type = type;
                teamChart.config.options = getChartOptions(type);
                teamChart.update();
                
                // 更新标签状态
                document.querySelectorAll('.chart-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.chart === type);
                });
                
                // 如果有选中的赛事，重新更新图表
                if (CONFIG.state.selectedGameId) {
                    updateTeamChart(CONFIG.state.selectedGameId);
                }
            }
        }

        function updateTeamChart(gameId) {
            // 更新选中状态
            CONFIG.state.selectedGameId = gameId;
            document.querySelectorAll('#betItemsTable tr').forEach(row => {
                row.classList.toggle('selected', row.cells[0]?.textContent === gameId);
            });
            
            const placeholder = document.getElementById('chartPlaceholder');
            const performanceData = AIAnalytics.performanceData[gameId];
            const prediction = AIAnalytics.predictionCache[gameId];
            
            if (!performanceData || !prediction || performanceData.teams.length < 2) {
                placeholder.style.display = 'flex';
                document.getElementById('chartInfo').textContent = '没有足够的数据分析';
                document.getElementById('predictionDetails').style.display = 'none';
                return;
            }
            
            // 隐藏占位符，显示详情面板
            placeholder.style.display = 'none';
            document.getElementById('predictionDetails').style.display = 'block';
            
            // 更新详情面板
            document.getElementById('keyFactor').textContent = performanceData.keyFactor;
            document.getElementById('recentTrend').textContent = performanceData.recentTrend;
            document.getElementById('historyRecord').textContent = 
                `${performanceData.teams[0].name} vs ${performanceData.teams[1].name}: ` +
                `${Math.round(performanceData.teams[0].factors.headToHead * 100)}% vs ${Math.round(performanceData.teams[1].factors.headToHead * 100)}%`;
            document.getElementById('oddsTrend').textContent = 
                performanceData.teams[0].factors.odds > performanceData.teams[1].factors.odds 
                    ? `${performanceData.teams[0].name} 更被看好` 
                    : `${performanceData.teams[1].name} 更被看好`;
            
            // 更新图表信息
            document.getElementById('chartInfo').textContent = 
                `赛事 #${gameId} 分析: ${prediction.prediction} 获胜概率更高（可信度: ${(prediction.confidence * 100).toFixed(1)}%）`;
            
            // 更新图表数据
            teamChart.data.datasets[0].label = performanceData.teams[0].name;
            teamChart.data.datasets[0].data = [
                performanceData.teams[0].factors.winRate * 100,
                performanceData.teams[0].factors.recentForm * 100,
                performanceData.teams[0].factors.headToHead * 100,
                performanceData.teams[0].factors.odds * 100,
                performanceData.teams[0].factors.trend * 100,
                performanceData.teams[0].factors.homeAway * 100
            ];
            
            teamChart.data.datasets[1].label = performanceData.teams[1].name;
            teamChart.data.datasets[1].data = [
                performanceData.teams[1].factors.winRate * 100,
                performanceData.teams[1].factors.recentForm * 100,
                performanceData.teams[1].factors.headToHead * 100,
                performanceData.teams[1].factors.odds * 100,
                performanceData.teams[1].factors.trend * 100,
                performanceData.teams[1].factors.homeAway * 100
            ];
            
            teamChart.update();
        }

        // 渲染投注项目表格
        function renderBetTable() {
            const table = document.getElementById("betItemsTable");
            if (!table) return;

            if (CONFIG.state.availableBets.length === 0) {
                table.innerHTML = `
                    <tr>
                        <th>赛事ID</th>
                        <th>赛事描述</th>
                        <th>投注选项（赔率）</th>
                        <th>最高赔率</th>
                        <th>AI预测结果</th>
                        <th>更新时间</th>
                    </tr>
                    <tr>
                        <td colspan="6" style="text-align:center;padding:30px;color:rgba(255,255,255,0.3);">
                            <i class="fa fa-info-circle" aria-hidden="true"></i> 暂无数据，请获取赛事项目
                        </td>
                    </tr>
                `;
                return;
            }

            let html = `
                <tr>
                    <th>赛事ID</th>
                    <th>赛事描述</th>
                    <th>投注选项（赔率）</th>
                    <th>最高赔率</th>
                    <th>AI预测结果</th>
                    <th>更新时间</th>
                </tr>
            `;

            CONFIG.state.availableBets.forEach(item => {
                const highestOption = AIAnalytics.getHighestOddsOption(item);
                const aiPrediction = AIAnalytics.predictionCache[item.id];
                
                let optionsHtml = "";
                item.optionsList.forEach(opt => {
                    const isPredicted = aiPrediction && opt.text.includes(aiPrediction.prediction);
                    const isHighest = highestOption && opt.id === highestOption.id;
                    
                    optionsHtml += `<div ${isPredicted ? 'style="font-weight:bold;color:#7B61FF;"' : ''}>
                        ${opt.text} 
                        <span class="odds-highlight">(${opt.odds})</span>
                        ${isHighest ? '<span style="color:#52C41A;font-size:11px;">(最高)</span>' : ''}
                        ${isPredicted ? '<span style="color:#7B61FF;font-size:11px;">(AI预测)</span>' : ''}
                    </div>`;
                });

                const predictionHtml = aiPrediction 
                    ? `<div class="prediction-highlight">
                        ${aiPrediction.prediction}
                        <div style="font-size:12px;color:#bbb;">可信度: ${(aiPrediction.confidence * 100).toFixed(1)}%</div>
                        <div style="font-size:11px;color:#999;">核心因素: ${aiPrediction.keyFactor}</div>
                    </div>`
                    : '<div><i class="fa fa-circle-o-notch fa-spin" aria-hidden="true"></i> 分析中...</div>';

                const updateTime = aiPrediction 
                    ? new Date(aiPrediction.timestamp).toLocaleTimeString()
                    : '-';

                // 为行添加点击事件
                html += `
                    <tr style="cursor:pointer;" onclick="updateTeamChart('${item.id}')" ${CONFIG.state.selectedGameId === item.id ? 'class="selected"' : ''}>
                        <td>${item.id}</td>
                        <td>${item.heading}</td>
                        <td>${optionsHtml}</td>
                        <td class="odds-highlight">${highestOption ? highestOption.odds : "N/A"}</td>
                        <td>${predictionHtml}</td>
                        <td>${updateTime}</td>
                    </tr>
                `;
            });

            table.innerHTML = html;
        }

        // 赛事搜索功能
        function setupEventSearch() {
            const searchInput = document.getElementById('searchEvents');
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#betItemsTable tr');
                
                rows.forEach((row, index) => {
                    // 跳过表头
                    if (index === 0) return;
                    
                    const eventId = row.cells[0].textContent.toLowerCase();
                    const eventDesc = row.cells[1].textContent.toLowerCase();
                    const options = row.cells[2].textContent.toLowerCase();
                    
                    const matches = eventId.includes(searchTerm) || 
                                   eventDesc.includes(searchTerm) || 
                                   options.includes(searchTerm);
                    
                    row.style.display = matches ? '' : 'none';
                });
            });
        }

        // 辅助函数
        function updateApiStatus(success) {
            const statusEl = document.getElementById("apiStatus");
            if (success === 'pending') {
                statusEl.innerHTML = '<i class="fa fa-circle-o-notch fa-spin" aria-hidden="true"></i> 验证中';
                statusEl.className = "status status-pending";
            } else if (success) {
                statusEl.innerHTML = '<i class="fa fa-check" aria-hidden="true"></i> 验证成功';
                statusEl.className = "status status-success";
            } else {
                statusEl.innerHTML = '<i class="fa fa-times" aria-hidden="true"></i> 验证失败';
                statusEl.className = "status status-error";
            }
        }

        // 字符串哈希函数
        String.prototype.hashCode = function() {
            let hash = 0;
            for (let i = 0; i < this.length; i++) {
                const char = this.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash);
        };

        // 自动刷新机制
        function startAutoRefresh() {
            setInterval(async () => {
                Logger.info("执行定时AI数据更新（10分钟周期）");
                if (CONFIG.state.apiKey) {
                    await loadBetItems();
                } else {
                    Logger.warning("API未验证，跳过自动更新");
                }
            }, CONFIG.state.autoRefreshInterval);
            Logger.info(`自动刷新机制已启动（每${CONFIG.state.autoRefreshInterval/60000}分钟）`);
        }

        // 页面初始化
        document.addEventListener("DOMContentLoaded", () => {
            // 初始化图表
            initTeamChart();
            document.getElementById('chartPlaceholder').style.display = 'flex';
            
            // 绑定按钮事件
            document.getElementById("verifyApiBtn").addEventListener("click", async () => {
                const apiKey = document.getElementById("apiKeyInput").value;
                await verifyApiKey(apiKey);
            });

            document.getElementById("loadBetsBtn").addEventListener("click", loadBetItems);
            
            document.getElementById("refreshAiBtn").addEventListener("click", async () => {
                if (CONFIG.state.availableBets.length > 0) {
                    Logger.info("手动触发AI分析刷新");
                    showTableLoading();
                    await analyzeAllBets();
                    renderBetTable();
                } else {
                    Logger.warning("请先获取赛事项目");
                }
            });

            // 导出数据按钮
            document.getElementById("exportDataBtn").addEventListener("click", () => {
                AIAnalytics.exportAnalysis();
            });

            // 清空日志按钮
            document.getElementById("clearLogBtn").addEventListener("click", () => {
                document.getElementById("logPanel").innerHTML = "";
                Logger.info("日志已清空");
            });

            // 图表切换
            document.querySelectorAll('.chart-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchChartType(tab.dataset.chart);
                });
            });

            // 设置赛事搜索
            setupEventSearch();

            // 启动自动刷新
            startAutoRefresh();
            
            Logger.info("系统初始化完成，等待API验证...");
        });
    </script>
</body>
</html>
